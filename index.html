<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 정의 말씀 슬라이드</title>
    <!-- html2canvas 라이브러리 (스크린샷 기능) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBL5gI9kLmbG4dGzcPTQsROJAgaA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Noto+Sans+KR:wght@400;700&family=Nanum+Gothic:wght@400;700&family=Gowun+Batang:wght@400;700&family=Jua&family=Do+Hyeon&family=Black+Han+Sans&family=East+Sea+Dokdo&family=Gaegu&family=Single+Day&family=Spoqa+Han+Sans+Neo:wght@400;700&family=IBM+Plex+Sans+KR:wght@400;700&family=Tmoney+Round+Wind:wght@400;700&family=Gothic+A1:wght@400;700&family=Nanum+Myeongjo:wght@400;700&family=Nanum+Pen+Script&family=Sunflower:wght@500;700&family=Stylish&family=Dokdo&family=Black+And+White+Picture&family=Cute+Font&family=Hi+Melody&family=Kirang+Haerang&family=Poor+Story&family=Song+Myung&family=Gamja+Flower&family=Yeon+Sung&family=Noto+Serif+KR:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS 변수를 사용한 테마 설정 */
        :root {
            --bg-color: #f8fafc;
            --main-text-color: #1e293b;
            --verse-text-color: #ffffff;
            --reference-text-color: #cbd5e1;
            --accent-color: #fcd34d;
            --highlight-text-color: #60a5fa;
            --box-bg-color: #1e293b;
            --button-color: #3b82f6;
            --verse-font-size: 2.2rem;
            --reference-font-size: 1.3rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-color);
            color: var(--main-text-color);
            overflow-y: auto;
            padding: 1rem 0;
            transition: background-color 0.3s ease;
        }

        /* 웹 폰트 클래스 */
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-noto-sans-kr { font-family: 'Noto Sans KR', sans-serif; }
        .font-nanum-gothic { font-family: 'Nanum Gothic', sans-serif; }
        .font-spoqa-han-sans-neo { font-family: 'Spoqa Han Sans Neo', sans-serif; }
        .font-ibm-plex-sans-kr { font-family: 'IBM Plex Sans KR', sans-serif; }
        .font-gothic-a1 { font-family: 'Gothic A1', sans-serif; }
        .font-nanum-myeongjo { font-family: 'Nanum Myeongjo', serif; }
        .font-gowun-batang { font-family: 'Gowun Batang', serif; }
        .font-noto-serif-kr { font-family: 'Noto Serif KR', serif; }
        .font-song-myung { font-family: 'Song Myung', serif; }
        .font-jua { font-family: 'Jua', sans-serif; }
        .font-do-hyeon { font-family: 'Do Hyeon', sans-serif; }
        .font-black-han-sans { font-family: 'Black Han Sans', sans-serif; }
        .font-tmoney-round-wind { font-family: 'Tmoney Round Wind', sans-serif; }
        .font-yeon-sung { font-family: 'Yeon Sung', cursive; }
        .font-sunflower { font-family: 'Sunflower', sans-serif; }
        .font-stylish { font-family: 'Stylish', sans-serif; }
        .font-gamja-flower { font-family: 'Gamja Flower', cursive; }
        .font-nanum-pen-script { font-family: 'Nanum Pen Script', cursive; }
        .font-gaegu { font-family: 'Gaegu', cursive; }
        .font-hi-melody { font-family: 'Hi Melody', cursive; }
        .font-poor-story { font-family: 'Poor Story', cursive; }
        .font-kirang-haerang { font-family: 'Kirang Haerang', cursive; }
        .font-cute-font { font-family: 'Cute Font', cursive; }
        .font-dokdo { font-family: 'Dokdo', cursive; }
        .font-east-sea-dokdo { font-family: 'East Sea Dokdo', cursive; }
        .font-black-and-white-picture { font-family: 'Black And White Picture', sans-serif; }
        .font-single-day { font-family: 'Single Day', cursive; }

        /* 단어 강조 스타일 */
        .highlight {
            color: var(--highlight-text-color);
            font-weight: 700;
        }

        /* 컨트롤 패널 */
        .controls {
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            background-color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            position: relative;
            z-index: 10;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .controls label {
            font-size: 1rem;
            font-weight: 600;
            color: #334155;
            white-space: nowrap;
        }

        .controls select,
        .controls input,
        .controls button.action-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
            background-color: #f8fafc;
            font-size: 1rem;
            font-weight: 500;
            color: #1e293b;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }
        .controls input[type="range"] { padding: 0; }
        .controls select:focus,
        .controls input:focus,
        .controls button.action-button:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        /* 색상 선택기 스타일 */
        .controls input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 40px; height: 40px; padding: 0; border: none; background: none; cursor: pointer;
        }
        .controls input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        .controls input[type="color"]::-webkit-color-swatch { border: 1px solid #cbd5e1; border-radius: 0.5rem; }
        .controls input[type="color"]::-moz-color-swatch { border: 1px solid #cbd5e1; border-radius: 0.5rem; }

        /* 기능 버튼 스타일 */
        .controls button.action-button { color: white; font-weight: 600; }
        .controls button#screenshotBtn { background-color: #10b981; }
        .controls button#screenshotBtn:hover { background-color: #059669; }
        .controls button#saveAllBtn { background-color: #0891b2; }
        .controls button#saveAllBtn:hover { background-color: #0e7490; }
        .controls button#addVerseBtn { background-color: #8b5cf6; }
        .controls button#addVerseBtn:hover { background-color: #7c3aed; }
        .controls button#highlightBtn { background-color: #0d9488; }
        .controls button#highlightBtn:hover { background-color: #0f766e; }
        .controls button#loadFromFileBtn { background-color: #f59e0b; }
        .controls button#loadFromFileBtn:hover { background-color: #d97706; }
        .controls button.gemini-btn { background-color: #64748b; }
        .controls button.gemini-btn:hover { background-color: #475569; }
        .controls button.action-button:disabled { background-color: #9ca3af; cursor: not-allowed; }

        /* 메인 슬라이드 */
        .slide-wrapper {
            width: 90%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
            position: relative;
        }

        .verse-box {
            background-color: var(--box-bg-color);
            border-radius: 1rem;
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            padding: 2.5rem 3rem;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative;
            transition: background-color 0.3s ease;
        }

        .verse-text-container { position: relative; padding-left: 1.5rem; }
        .vertical-line { position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background-color: var(--accent-color); border-radius: 3px; transition: background-color 0.3s ease; }
        .verse-text { font-size: var(--verse-font-size); line-height: 1.7; color: var(--verse-text-color); font-weight: 600; transition: color 0.3s ease, font-size 0.2s ease; }
        .verse-reference { font-size: var(--reference-font-size); color: var(--reference-text-color); font-weight: 400; text-align: right; margin-top: 1rem; transition: color 0.3s ease, font-size 0.2s ease; }

        /* 이전/다음 버튼 */
        .navigation-buttons { display: flex; justify-content: space-between; width: 100%; max-width: 400px; margin-top: 2rem; }
        .nav-button { background-color: var(--button-color); color: white; padding: 0.8rem 2rem; border: none; border-radius: 9999px; cursor: pointer; font-size: 1.1rem; font-weight: 600; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .nav-button:hover { background-color: #2563eb; transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); }
        .nav-button:disabled { background-color: #9ca3af; cursor: not-allowed; box-shadow: none; transform: none; }

        /* 팝업창 (모달) 스타일 */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); width: 90%; max-width: 600px; display: flex; flex-direction: column; gap: 1rem; max-height: 80vh; }
        .modal-content h2 { margin-top: 0; font-size: 1.5rem; font-weight: 700; color: #1e293b; }
        .modal-content p { color: #475569; }
        #geminiResultContent { overflow-y: auto; background-color: #f1f5f9; padding: 1rem; border-radius: 0.5rem; color: #334155; }
        #geminiResultContent h3 { font-size: 1.2rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: #1e293b; }
        #geminiResultContent ul, #geminiResultContent ol { padding-left: 1.5rem; }
        #geminiResultContent li { margin-bottom: 0.5rem; }
        #geminiResultContent p { margin-bottom: 1rem; }
        .modal-content .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .modal-content label { font-weight: 600; color: #475569; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-size: 1rem; box-sizing: border-box; }
        .modal-content textarea { resize: vertical; min-height: 120px; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1rem; }
        .modal-buttons button { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; }
        .modal-buttons .save-btn { background-color: #3b82f6; color: white; }
        .modal-buttons .cancel-btn { background-color: #e2e8f0; color: #475569; }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .verse-text { font-size: var(--verse-font-size); }
            .verse-reference { font-size: var(--reference-font-size); }
        }
    </style>
</head>
<body>
    <!-- 컨트롤 패널 -->
    <div class="controls">
        <div class="control-group">
            <label for="font-select">웹 글꼴:</label>
            <select id="font-select">
                <optgroup label="Sans-serif (고딕 계열)">
                    <option value="inter">Inter (기본)</option>
                    <option value="noto-sans-kr">Noto Sans KR</option>
                    <option value="nanum-gothic">나눔고딕</option>
                    <option value="spoqa-han-sans-neo">Spoqa Han Sans Neo</option>
                    <option value="ibm-plex-sans-kr">IBM Plex Sans KR</option>
                    <option value="gothic-a1">Gothic A1</option>
                </optgroup>
                <optgroup label="Serif (명조 계열)">
                    <option value="nanum-myeongjo">나눔명조</option>
                    <option value="gowun-batang">고운바탕</option>
                    <option value="noto-serif-kr">Noto Serif KR</option>
                    <option value="song-myung">송명</option>
                </optgroup>
                 <optgroup label="Display (제목용)">
                    <option value="jua">주아체</option>
                    <option value="do-hyeon">도현체</option>
                    <option value="black-han-sans">Black Han Sans</option>
                    <option value="tmoney-round-wind">티머니 둥근바람</option>
                    <option value="yeon-sung">연성</option>
                    <option value="sunflower">해바라기</option>
                    <option value="stylish">스타일리쉬</option>
                </optgroup>
                <optgroup label="Handwriting (손글씨)">
                    <option value="gamja-flower">감자꽃</option>
                    <option value="nanum-pen-script">나눔 펜 스크립트</option>
                    <option value="gaegu">개구체</option>
                    <option value="hi-melody">하이멜로디</option>
                    <option value="poor-story">푸어 스토리</option>
                    <option value="kirang-haerang">키랑해랑</option>
                    <option value="cute-font">큐트 폰트</option>
                    <option value="single-day">싱글 데이</option>
                </optgroup>
                 <optgroup label="Unique (독특한 글꼴)">
                    <option value="dokdo">독도</option>
                    <option value="east-sea-dokdo">동해독도</option>
                    <option value="black-and-white-picture">흑백사진</option>
                </optgroup>
            </select>
        </div>
        <div class="control-group">
            <label for="font-size-slider">글꼴 크기:</label>
            <input type="range" id="font-size-slider" min="1" max="4.5" step="0.1" value="2.2">
            <span id="font-size-value" class="w-12 text-center">2.2rem</span>
        </div>
        <div class="control-group">
            <label for="verse-select">구절 선택:</label>
            <select id="verse-select"></select>
        </div>
        <div class="control-group">
            <label for="highlight-input">강조 단어:</label>
            <input type="text" id="highlight-input" placeholder="단어1,단어2...">
            <button id="highlightBtn" class="action-button" style="padding: 0.5rem;">강조</button>
        </div>
        <div class="control-group">
            <label for="bg-color-picker">배경색:</label> <input type="color" id="bg-color-picker" value="#f8fafc">
        </div>
        <div class="control-group">
            <label for="verse-box-bg-color-picker">상자 배경:</label> <input type="color" id="verse-box-bg-color-picker" value="#1e293b">
        </div>
        <div class="control-group">
            <label for="verse-text-color-picker">말씀색:</label> <input type="color" id="verse-text-color-picker" value="#ffffff">
        </div>
        <div class="control-group">
            <label for="reference-text-color-picker">참조색:</label> <input type="color" id="reference-text-color-picker" value="#cbd5e1">
        </div>
        <div class="control-group">
            <label for="accent-color-picker">막대바 색:</label> <input type="color" id="accent-color-picker" value="#fcd34d">
        </div>
        <div class="control-group">
            <label for="highlight-color-picker">단어 강조색:</label> <input type="color" id="highlight-color-picker" value="#60a5fa">
        </div>
        <div class="control-group">
             <button id="loadFromFileBtn" class="action-button">파일 불러오기</button>
             <button id="addVerseBtn" class="action-button">말씀 추가</button>
             <button id="screenshotBtn" class="action-button">현재 슬라이드 저장</button>
             <button id="saveAllBtn" class="action-button">모두 저장</button>
        </div>
         <div class="control-group">
            <button id="gemini-explain-btn" class="action-button gemini-btn">말씀 해설</button>
            <button id="gemini-question-btn" class="action-button gemini-btn">적용 질문</button>
            <button id="gemini-lexicon-btn" class="action-button gemini-btn">중요 원어 해설</button>
            <button id="gemini-crossref-btn" class="action-button gemini-btn">관주 성경 구절</button>
        </div>
    </div>

    <!-- 메인 슬라이드 -->
    <div class="slide-wrapper" id="slideWrapper">
        <div class="verse-box">
            <div class="verse-text-container">
                <div class="vertical-line"></div>
                <div class="verse-text" id="verseText"></div>
            </div>
            <div class="verse-reference" id="verseReference"></div>
        </div>
        <div class="navigation-buttons">
            <button id="prevBtn" class="nav-button">이전</button>
            <button id="nextBtn" class="nav-button">다음</button>
        </div>
    </div>

    <!-- 말씀 추가 모달 -->
    <div id="addVerseModal" class="modal-overlay">
        <div class="modal-content">
            <h2>새 말씀 구절 추가</h2>
            <form id="addVerseForm">
                <div class="form-group">
                    <label for="newVerseReference">참조 (예: 요한복음 3:16)</label>
                    <input type="text" id="newVerseReference" required>
                </div>
                <div class="form-group">
                    <label for="newVerseText">말씀 내용</label>
                    <textarea id="newVerseText" rows="4" required></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="cancel-btn" id="cancelAddVerseBtn">취소</button>
                    <button type="submit" class="save-btn">저장</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 파일 불러오기 확인 모달 -->
    <div id="loadConfirmModal" class="modal-overlay">
        <div class="modal-content">
            <h2>말씀 불러오기</h2>
            <p id="load-confirm-message"></p>
            <div class="modal-buttons">
                <button id="replace-btn" class="save-btn">현재 목록 교체</button>
                <button id="append-btn" class="action-button" style="background-color: #10b981;">목록에 추가</button>
                <button id="cancel-load-btn" class="cancel-btn">취소</button>
            </div>
        </div>
    </div>

    <!-- Gemini AI 결과 모달 -->
    <div id="geminiResultModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="geminiResultTitle">AI 생성 결과</h2>
            <div id="geminiResultContent">생성 중...</div>
            <div class="modal-buttons">
                <button id="copyGeminiResultBtn" class="action-button" style="background-color: #10b981;">내용 복사</button>
                <button id="closeGeminiResultBtn" class="cancel-btn">닫기</button>
            </div>
        </div>
    </div>
    
    <input type="file" id="file-loader" class="hidden" accept=".txt">

    <script>
        const initialVerses = [
             { reference: "이사야 55:1", text: "너희 목마른 자들아 물로 나아오라 돈 없는 자도 오라 너희는 와서 사 먹되 돈 없이, 값 없이 와서 포도주와 젖을 사라" },
            { reference: "시편 90:10", text: "우리의 년수가 칠십이요 강건하면 팔십이라도 그 년수의 자랑은 수고와 슬픔 뿐이요 신속히 가니 우리가 날아가나이다" },
            { reference: "이사야 55:3", text: "너희는 귀를 기울이고 내게 나아와 들으라 그리하면 너희 영혼이 살리라 내가 너희에게 영원한 언약을 세우리니 곧 다윗에게 허락한 확실한 은혜니라" },
            { reference: "요한복음 8:32", text: "진리를 알찌니 진리가 너희를 자유케 하리라" },
            { reference: "로마서 5:8", text: "우리가 아직 죄인 되었을 때에 그리스도께서 우리를 위하여 죽으심으로 하나님께서 우리에게 대한 자기의 사랑을 확증하셨느니라" },
            { reference: "요한복음 3:16", text: "하나님이 세상을 이처럼 사랑하사 독생자를 주셨으니 이는 저를 믿는 자마다 멸망치 않고 영생을 얻게 하려 하심이니라" }
        ];
        
        const allFontClasses = [
            'font-inter', 'font-noto-sans-kr', 'font-nanum-gothic', 'font-spoqa-han-sans-neo', 'font-ibm-plex-sans-kr', 'font-gothic-a1',
            'font-nanum-myeongjo', 'font-gowun-batang', 'font-noto-serif-kr', 'font-song-myung',
            'font-jua', 'font-do-hyeon', 'font-black-han-sans', 'font-tmoney-round-wind', 'font-yeon-sung', 'font-sunflower', 'font-stylish',
            'font-gamja-flower', 'font-nanum-pen-script', 'font-gaegu', 'font-hi-melody', 'font-poor-story', 'font-kirang-haerang', 'font-cute-font', 'font-single-day',
            'font-dokdo', 'font-east-sea-dokdo', 'font-black-and-white-picture'
        ];

        let verses = [];
        let currentSlideIndex = 0;
        let isTransitioning = false;
        let isCapturing = false;
        let parsedVersesFromFile = [];

        // DOM 요소 캐싱
        const verseText = document.getElementById('verseText');
        const verseReference = document.getElementById('verseReference');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const slideWrapper = document.getElementById('slideWrapper');
        const fontSelect = document.getElementById('font-select');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValue = document.getElementById('font-size-value');
        const verseSelect = document.getElementById('verse-select');
        const bgColorPicker = document.getElementById('bg-color-picker');
        const verseBoxBgColorPicker = document.getElementById('verse-box-bg-color-picker');
        const verseTextColorPicker = document.getElementById('verse-text-color-picker');
        const referenceTextColorPicker = document.getElementById('reference-text-color-picker');
        const accentColorPicker = document.getElementById('accent-color-picker');
        const highlightColorPicker = document.getElementById('highlight-color-picker');
        const screenshotBtn = document.getElementById('screenshotBtn');
        const saveAllBtn = document.getElementById('saveAllBtn');
        const highlightInput = document.getElementById('highlight-input');
        const highlightBtn = document.getElementById('highlightBtn');
        const addVerseBtn = document.getElementById('addVerseBtn');
        const addVerseModal = document.getElementById('addVerseModal');
        const addVerseForm = document.getElementById('addVerseForm');
        const cancelAddVerseBtn = document.getElementById('cancelAddVerseBtn');
        const newVerseReferenceInput = document.getElementById('newVerseReference');
        const newVerseTextInput = document.getElementById('newVerseText');
        const loadFromFileBtn = document.getElementById('loadFromFileBtn');
        const fileLoader = document.getElementById('file-loader');
        const loadConfirmModal = document.getElementById('loadConfirmModal');
        const loadConfirmMessage = document.getElementById('load-confirm-message');
        const replaceBtn = document.getElementById('replace-btn');
        const appendBtn = document.getElementById('append-btn');
        const cancelLoadBtn = document.getElementById('cancel-load-btn');
        const geminiExplainBtn = document.getElementById('gemini-explain-btn');
        const geminiQuestionBtn = document.getElementById('gemini-question-btn');
        const geminiLexiconBtn = document.getElementById('gemini-lexicon-btn');
        const geminiCrossrefBtn = document.getElementById('gemini-crossref-btn');
        const geminiResultModal = document.getElementById('geminiResultModal');
        const geminiResultTitle = document.getElementById('geminiResultTitle');
        const geminiResultContent = document.getElementById('geminiResultContent');
        const copyGeminiResultBtn = document.getElementById('copyGeminiResultBtn');
        const closeGeminiResultBtn = document.getElementById('closeGeminiResultBtn');

        // --- 데이터 관리 ---
        function saveStateToLocalStorage() {
            const state = {
                verses: verses,
                highlightWords: highlightInput.value,
                fontSize: fontSizeSlider.value,
                fontName: fontSelect.value,
                colors: {
                    bg: bgColorPicker.value,
                    boxBg: verseBoxBgColorPicker.value,
                    verseText: verseTextColorPicker.value,
                    refText: referenceTextColorPicker.value,
                    accent: accentColorPicker.value,
                    highlight: highlightColorPicker.value
                }
            };
            localStorage.setItem('customBibleAppState', JSON.stringify(state));
        }

        function loadStateFromLocalStorage() {
            const savedState = localStorage.getItem('customBibleAppState');
            if (savedState) {
                const state = JSON.parse(savedState);
                verses = state.verses && state.verses.length > 0 ? state.verses : initialVerses;
                highlightInput.value = state.highlightWords || '';
                
                fontSizeSlider.value = state.fontSize || '2.2';
                fontSizeSlider.dispatchEvent(new Event('input'));
                
                fontSelect.value = state.fontName || 'inter';
                fontSelect.dispatchEvent(new Event('change'));

                if (state.colors) {
                    bgColorPicker.value = state.colors.bg || '#f8fafc';
                    verseBoxBgColorPicker.value = state.colors.boxBg || '#1e293b';
                    verseTextColorPicker.value = state.colors.verseText || '#ffffff';
                    referenceTextColorPicker.value = state.colors.refText || '#cbd5e1';
                    accentColorPicker.value = state.colors.accent || '#fcd34d';
                    highlightColorPicker.value = state.colors.highlight || '#60a5fa';
                    
                    document.documentElement.style.setProperty('--bg-color', bgColorPicker.value);
                    document.body.style.backgroundColor = bgColorPicker.value;
                    document.documentElement.style.setProperty('--box-bg-color', verseBoxBgColorPicker.value);
                    document.documentElement.style.setProperty('--verse-text-color', verseTextColorPicker.value);
                    document.documentElement.style.setProperty('--reference-text-color', referenceTextColorPicker.value);
                    document.documentElement.style.setProperty('--accent-color', accentColorPicker.value);
                    document.documentElement.style.setProperty('--highlight-text-color', highlightColorPicker.value);
                }

            } else {
                verses = initialVerses;
            }
        }

        // --- UI 업데이트 ---
        function updateSlide(isBatch = false) {
            if (verses.length === 0) {
                verseText.textContent = "말씀을 추가하거나 파일에서 불러오세요.";
                verseReference.textContent = "";
                if (!isBatch) updateButtonStates();
                return;
            }
            const verse = verses[currentSlideIndex];
            const highlightWords = highlightInput.value.trim().split(',').filter(word => word.trim() !== '');

            verseReference.textContent = verse.reference;
            
            let newText = verse.text;

            if (highlightWords.length > 0) {
                const escapedWords = highlightWords.map(word => word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
                const regex = new RegExp(`(${escapedWords.join('|')})`, 'gi');
                newText = verse.text.replace(regex, `<span class="highlight">$1</span>`);
            }
            
            verseText.innerHTML = newText;
            if (!isBatch) {
                verseSelect.value = currentSlideIndex;
                updateButtonStates();
            }
        }

        function updateButtonStates() {
            const disabled = isTransitioning || isCapturing;
            const noVerses = verses.length === 0;
            prevBtn.disabled = currentSlideIndex === 0 || disabled || noVerses;
            nextBtn.disabled = currentSlideIndex === verses.length - 1 || disabled || noVerses;
            screenshotBtn.disabled = disabled || noVerses;
            saveAllBtn.disabled = disabled || noVerses;
            addVerseBtn.disabled = disabled;
            loadFromFileBtn.disabled = disabled;
            highlightBtn.disabled = disabled;
            geminiExplainBtn.disabled = disabled || noVerses;
            geminiQuestionBtn.disabled = disabled || noVerses;
            geminiLexiconBtn.disabled = disabled || noVerses;
            geminiCrossrefBtn.disabled = disabled || noVerses;
            
            if (isCapturing) {
                screenshotBtn.textContent = '저장 중...';
                saveAllBtn.textContent = '저장 중...';
            } else {
                screenshotBtn.textContent = '현재 슬라이드 저장';
                saveAllBtn.textContent = '모두 저장';
            }
        }

        function transitionSlide(newIndex) {
            if (isTransitioning || isCapturing || newIndex < 0 || newIndex >= verses.length) return;

            isTransitioning = true;
            updateButtonStates();
            slideWrapper.style.opacity = '0';
            
            setTimeout(() => {
                currentSlideIndex = newIndex;
                updateSlide();
                slideWrapper.style.transition = 'none';
                slideWrapper.style.opacity = '0';
                void slideWrapper.offsetWidth;
                setTimeout(() => {
                    slideWrapper.style.transition = 'opacity 0.5s ease-in-out';
                    slideWrapper.style.opacity = '1';
                    setTimeout(() => {
                        isTransitioning = false;
                        updateButtonStates();
                    }, 500);
                }, 10);
            }, 500);
        }

        function refreshVerseSelect() {
            verseSelect.innerHTML = '';
            verses.forEach((verse, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = verse.reference;
                verseSelect.appendChild(option);
            });
            verseSelect.value = currentSlideIndex;
        }

        // --- 기능 함수 ---
        async function captureAndDownloadSlide(verse) {
            const elementToCapture = document.getElementById('slideWrapper');
            const navButtons = elementToCapture.querySelector('.navigation-buttons');
            navButtons.style.display = 'none';

            const sourceCanvas = await html2canvas(elementToCapture, { useCORS: true, scale: 4, backgroundColor: null });
            navButtons.style.display = 'flex';

            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = 3840;
            finalCanvas.height = 2160;
            const ctx = finalCanvas.getContext('2d');
            ctx.fillStyle = getComputedStyle(document.body).backgroundColor;
            ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

            const sourceAspectRatio = sourceCanvas.width / sourceCanvas.height;
            const targetAspectRatio = finalCanvas.width / finalCanvas.height;
            let drawWidth, drawHeight, x, y;
            if (sourceAspectRatio > targetAspectRatio) {
                drawWidth = finalCanvas.width;
                drawHeight = drawWidth / sourceAspectRatio;
                x = 0; y = (finalCanvas.height - drawHeight) / 2;
            } else {
                drawHeight = finalCanvas.height;
                drawWidth = drawHeight * sourceAspectRatio;
                y = 0; x = (finalCanvas.width - drawWidth) / 2;
            }
            ctx.drawImage(sourceCanvas, x, y, drawWidth, drawHeight);

            const imageURL = finalCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = imageURL;
            const date = new Date();
            const filename = `${verse.reference.replace(/[:–\s]/g, '_')}_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}_4K.png`;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        async function saveAllSlides() {
            if (isCapturing || verses.length === 0) return;
            
            isCapturing = true;
            updateButtonStates();
            
            const originalIndex = currentSlideIndex;
            const originalButtonText = saveAllBtn.textContent;

            for (let i = 0; i < verses.length; i++) {
                currentSlideIndex = i;
                updateSlide(true);
                saveAllBtn.textContent = `저장 중... (${i + 1}/${verses.length})`;
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                try {
                    await captureAndDownloadSlide(verses[i]);
                } catch (error) {
                    console.error(`Slide ${i} 저장 실패:`, error);
                    alert(`${verses[i].reference} 슬라이드 저장에 실패했습니다. 계속 진행합니다.`);
                }
            }
            
            currentSlideIndex = originalIndex;
            updateSlide();
            
            isCapturing = false;
            saveAllBtn.textContent = originalButtonText;
            updateButtonStates();
            alert(`${verses.length}개의 슬라이드 저장이 완료되었습니다.`);
        }

        function openModal(modal) { modal.style.display = 'flex'; }
        function closeModal(modal) { modal.style.display = 'none'; }

        function handleAddVerse(event) {
            event.preventDefault();
            const newRef = newVerseReferenceInput.value.trim();
            const newText = newVerseTextInput.value.trim();
            if (!newRef || !newText) { alert('참조와 말씀 내용을 모두 입력해주세요.'); return; }
            verses.push({ reference: newRef, text: newText });
            currentSlideIndex = verses.length - 1;
            refreshVerseSelect();
            updateSlide();
            closeModal(addVerseModal);
            addVerseForm.reset();
            saveStateToLocalStorage();
        }
        
        function parseVerseFile(content) {
            const newVerses = [];
            const blocks = content.trim().split(/\n\s*\n/);
            const verseRegex = /^\((.+?)\)\s*([\s\S]*)$/;

            for (const block of blocks) {
                const trimmedBlock = block.trim();
                if (!trimmedBlock) continue;

                const match = trimmedBlock.match(verseRegex);
                if (match && match[1] && match[2]) {
                    newVerses.push({
                        reference: match[1].trim(),
                        text: match[2].trim().replace(/\s+/g, ' ')
                    });
                } else {
                    console.warn("다음 블록을 파싱할 수 없습니다:", trimmedBlock);
                }
            }
            return newVerses;
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                parsedVersesFromFile = parseVerseFile(e.target.result);
                if (parsedVersesFromFile.length > 0) {
                    loadConfirmMessage.textContent = `파일에서 ${parsedVersesFromFile.length}개의 구절을 찾았습니다. 어떻게 추가하시겠습니까?`;
                    openModal(loadConfirmModal);
                } else {
                    alert("파일에서 유효한 형식의 말씀 구절을 찾지 못했습니다.\n형식: (참조) 내용");
                }
            };
            reader.readAsText(file);
            fileLoader.value = '';
        }
        
        function markdownToHtml(text) {
            return text
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>')
                .replace(/^\d+\. (.*$)/gim, '<ol><li>$1</li></ol>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/\n/g, '<br>')
                .replace(/<\/ul><br><ul>/g, '')
                .replace(/<\/ol><br><ol>/g, '');
        }

        async function callGeminiAPI(prompt) {
            geminiResultContent.innerHTML = '생성 중...';
            openModal(geminiResultModal);
            
            const apiKey = "AIzaSyABM_amTw-898hydlYgbS-eqJQ2AoWK8AI";

            if (!apiKey || apiKey === "YOUR_API_KEY_HERE") {
                 geminiResultContent.textContent = "오류: Gemini API 키가 설정되지 않았습니다. 코드의 'YOUR_API_KEY_HERE' 부분을 자신의 API 키로 교체해주세요.";
                 return;
            }

            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API 요청 실패: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    geminiResultContent.innerHTML = markdownToHtml(text);
                } else {
                    throw new Error('API 응답에서 내용을 찾을 수 없습니다.');
                }
            } catch (error) {
                console.error("Gemini API 호출 오류:", error);
                geminiResultContent.textContent = `오류가 발생했습니다: ${error.message}`;
            }
        }

        // --- 이벤트 리스너 설정 ---
        function setupEventListeners() {
            prevBtn.addEventListener('click', () => transitionSlide(currentSlideIndex - 1));
            nextBtn.addEventListener('click', () => transitionSlide(currentSlideIndex + 1));
            screenshotBtn.addEventListener('click', async () => {
                if (isCapturing) return;
                isCapturing = true;
                updateButtonStates();
                try {
                    await captureAndDownloadSlide(verses[currentSlideIndex]);
                } catch (error) {
                    console.error('Screenshot error:', error);
                    alert('스크린샷 생성에 실패했습니다.');
                } finally {
                    isCapturing = false;
                    updateButtonStates();
                }
            });
            saveAllBtn.addEventListener('click', saveAllSlides);
            
            fontSelect.addEventListener('change', (event) => {
                document.body.classList.remove(...allFontClasses);
                if (event.target.value) {
                    document.body.classList.add(`font-${event.target.value}`);
                }
                saveStateToLocalStorage();
            });

            fontSizeSlider.addEventListener('input', (event) => {
                const newSize = parseFloat(event.target.value);
                document.documentElement.style.setProperty('--verse-font-size', `${newSize}rem`);
                document.documentElement.style.setProperty('--reference-font-size', `${newSize * 0.6}rem`);
                fontSizeValue.textContent = `${newSize.toFixed(1)}rem`;
            });
            fontSizeSlider.addEventListener('change', saveStateToLocalStorage);

            verseSelect.addEventListener('change', (event) => transitionSlide(parseInt(event.target.value)));

            highlightBtn.addEventListener('click', () => {
                updateSlide();
                saveStateToLocalStorage();
            });
            highlightInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') highlightBtn.click();
            });

            const colorPickers = {
                '--bg-color': bgColorPicker,
                '--box-bg-color': verseBoxBgColorPicker,
                '--verse-text-color': verseTextColorPicker,
                '--reference-text-color': referenceTextColorPicker,
                '--accent-color': accentColorPicker,
                '--highlight-text-color': highlightColorPicker
            };
            for (const [prop, picker] of Object.entries(colorPickers)) {
                picker.addEventListener('input', (event) => {
                    document.documentElement.style.setProperty(prop, event.target.value);
                    if (prop === '--highlight-text-color') updateSlide();
                    if (prop === '--bg-color') document.body.style.backgroundColor = event.target.value;
                });
                 picker.addEventListener('change', saveStateToLocalStorage);
            }

            addVerseBtn.addEventListener('click', () => openModal(addVerseModal));
            cancelAddVerseBtn.addEventListener('click', () => closeModal(addVerseModal));
            addVerseModal.addEventListener('click', (event) => { if (event.target === addVerseModal) closeModal(addVerseModal); });
            addVerseForm.addEventListener('submit', handleAddVerse);
            
            loadFromFileBtn.addEventListener('click', () => fileLoader.click());
            fileLoader.addEventListener('change', handleFileLoad);
            
            replaceBtn.addEventListener('click', () => {
                verses = parsedVersesFromFile;
                currentSlideIndex = 0;
                refreshVerseSelect();
                updateSlide();
                saveStateToLocalStorage();
                closeModal(loadConfirmModal);
            });

            appendBtn.addEventListener('click', () => {
                verses.push(...parsedVersesFromFile);
                currentSlideIndex = verses.length - parsedVersesFromFile.length;
                refreshVerseSelect();
                updateSlide();
                saveStateToLocalStorage();
                closeModal(loadConfirmModal);
            });
            
            cancelLoadBtn.addEventListener('click', () => closeModal(loadConfirmModal));
            
            geminiExplainBtn.addEventListener('click', () => {
                const verse = verses[currentSlideIndex];
                geminiResultTitle.textContent = `'${verse.reference}' 해설`;
                const prompt = `다음 성경 구절인 '${verse.reference}: ${verse.text}'에 대해, 평신도가 이해하기 쉬운 간결한 해설을 작성해 주세요. 결과는 Markdown 형식을 사용하여 제목, 목록, 굵은 글씨 등으로 보기 좋게 정리해 주세요.`;
                callGeminiAPI(prompt);
            });

            geminiQuestionBtn.addEventListener('click', () => {
                const verse = verses[currentSlideIndex];
                geminiResultTitle.textContent = `'${verse.reference}' 적용 질문`;
                const prompt = `다음 성경 구절인 '${verse.reference}: ${verse.text}'을 개인의 삶에 적용해볼 수 있는 구체적인 질문 3가지를 작성해 주세요. 결과는 Markdown 형식을 사용하여 번호 목록으로 보기 좋게 정리해 주세요.`;
                callGeminiAPI(prompt);
            });
            
            geminiLexiconBtn.addEventListener('click', () => {
                const verse = verses[currentSlideIndex];
                geminiResultTitle.textContent = `'${verse.reference}' 중요 원어 해설`;
                const prompt = `다음 성경 구절인 '${verse.reference}: ${verse.text}'에 나오는 중요한 히브리어 또는 헬라어 원어 2~3개를 선택하여 그 깊은 의미를 설명해 주세요. 신학적 지식이 없는 평신도도 쉽게 이해할 수 있도록 명확하게 설명하고, 해당 원어가 성경의 다른 곳에서 어떻게 사용되는지 예시를 들어주세요. 결과는 Markdown 형식을 사용하여 보기 좋게 정리해 주세요.`;
                callGeminiAPI(prompt);
            });

            geminiCrossrefBtn.addEventListener('click', () => {
                const verse = verses[currentSlideIndex];
                geminiResultTitle.textContent = `'${verse.reference}' 관주 성경 구절`;
                const prompt = `다음 성경 구절인 '${verse.reference}: ${verse.text}'의 핵심 주제나 단어와 관련된 다른 성경 구절(관주)들을 5-7개 정도 찾아주세요. 각 구절이 왜 본문과 관련이 있는지 간략한 설명을 덧붙여 주세요. '성경은 성경으로 해석한다'는 원칙에 따라 본문의 의미를 더 깊이 이해하는 데 도움이 되어야 합니다. 결과는 Markdown 형식을 사용하여 보기 좋게 정리해 주세요.`;
                callGeminiAPI(prompt);
            });
            
            closeGeminiResultBtn.addEventListener('click', () => closeModal(geminiResultModal));
            copyGeminiResultBtn.addEventListener('click', () => {
                const textToCopy = geminiResultContent.innerText;
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    copyGeminiResultBtn.textContent = '복사 완료!';
                    setTimeout(() => {
                        copyGeminiResultBtn.textContent = '내용 복사';
                    }, 1500);
                } catch (err) {
                    console.error('복사 실패:', err);
                }
                document.body.removeChild(textArea);
            });
        }

        // --- 초기화 ---
        function initialize() {
            setupEventListeners();
            loadStateFromLocalStorage();
            refreshVerseSelect();
            updateSlide();
        }

        initialize();
    </script>
</body>
</html>

