<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ê²½ ë§ì”€ í”„ë¡œì í„°_v13_Apple_Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <!-- ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•´ Wasm ë²„ì „ì˜ sql.jsë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f9ff;
            /* iOSì—ì„œ ìŠ¤í¬ë¡¤ì´ ë¶€ë“œëŸ½ê²Œ ë˜ë„ë¡ ì„¤ì • */
            -webkit-overflow-scrolling: touch;
        }
        #search-result-display, #preview-display, #history-list {
            max-height: 25vh;
            overflow-y: auto;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e0f2fe; }
        ::-webkit-scrollbar-thumb { background: #7dd3fc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #38bdf8; }
        #preview-display::-webkit-scrollbar-track, #history-list::-webkit-scrollbar-track { background: #374151; }
        #preview-display::-webkit-scrollbar-thumb, #history-list::-webkit-scrollbar-thumb { background: #6b7280; }
        #preview-display::-webkit-scrollbar-thumb:hover, #history-list::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        #db-file-input, #logo-file-input { display: none; }
        .modal { transition: opacity 0.25s ease; }
        .search-result-item, .history-item { transition: background-color: 0.2s; }
        /* í„°ì¹˜ ê¸°ê¸°ì—ì„œ hover íš¨ê³¼ê°€ ë‚¨ì§€ ì•Šë„ë¡ ë¯¸ë””ì–´ ì¿¼ë¦¬ ì¶”ê°€ */
        @media (hover: hover) {
            .search-result-item:hover, .history-item:hover { background-color: #fef3c7; }
        }
        .align-btn.active { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-[200]">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm space-y-4">
            <h3 class="text-xl font-bold text-slate-800">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
            <p class="text-sm text-slate-600">í”„ë¡œê·¸ë¨ì— ì ‘ê·¼í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <div>
                <input type="password" id="password-input" class="w-full border-slate-300 rounded-md shadow-sm p-2 focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div class="text-right">
                <button id="password-submit-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl shadow-sky-200/50 p-8 space-y-6">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-sky-800">ì„±ê²½ ë§ì”€ í”„ë¡œì í„°</h1>
            <p class="text-slate-500 mt-2">ë¯¿ìŒì€ ë“¤ìŒì—ì„œ ë‚˜ë©° ë“¤ìŒì€ ê·¸ë¦¬ìŠ¤ë„ì˜ ë§ì”€ìœ¼ë¡œ ë§ë¯¸ì•”ì•˜ëŠë‹ˆë¼</p>
        </div>
        
        <div id="db-loader" class="hidden text-center p-6 border-2 border-dashed border-sky-300 rounded-2xl space-y-4">
              <div>
                  <label for="db-file-input" class="cursor-pointer w-full bg-sky-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-sky-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500 transition-all transform hover:scale-105 inline-block">
                      KOR.db íŒŒì¼ ì„ íƒí•˜ê¸°
                  </label>
                  <input type="file" id="db-file-input" accept=".db">
                  <p id="db-status" class="text-sm text-slate-500 mt-3">ì„±ê²½ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.</p>
              </div>
              <div>
                  <label for="logo-file-input" class="cursor-pointer w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all transform hover:scale-105 inline-block">
                      ë¡œê³  ì´ë¯¸ì§€ ì„ íƒ (ì„ íƒ ì‚¬í•­)
                  </label>
                  <input type="file" id="logo-file-input" accept="image/*">
                  <p id="logo-status" class="text-sm text-slate-500 mt-3">ë¡œê³ ë¥¼ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ 'ì„±ê²½' ë¬¸êµ¬ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
              </div>
        </div>

        <div id="main-content" class="hidden">
            <div id="initial-view">
                <button id="open-window-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all transform hover:scale-105">
                    ë§ì”€ ì°½ ì—´ê¸°
                </button>
            </div>

            <div id="control-panel" class="hidden space-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="verse-input" class="block text-sm font-medium text-slate-600">êµ¬ì ˆ ê²€ìƒ‰ (ì˜ˆ: ì°½ 1:1, ì‹œ 23:1-6)</label>
                        <div class="mt-1 flex rounded-xl shadow-sm">
                            <button id="prev-verse-btn" class="inline-flex items-center rounded-l-xl border border-r-0 border-slate-300 bg-slate-200 px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>ì´ì „</button>
                            <button id="next-verse-btn" class="inline-flex items-center border border-y-slate-300 border-x-0 bg-slate-200 px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>ë‹¤ìŒ</button>
                            <input type="text" id="verse-input" class="flex-1 block w-full rounded-none border-slate-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3" placeholder="ì°½ 1:1-5">
                            <button id="display-btn" class="inline-flex items-center border border-l-0 border-blue-500 bg-blue-500 px-5 py-2 text-sm font-bold text-white hover:bg-blue-600 transition-colors">ë„ìš°ê¸°</button>
                            <button id="open-history-modal-btn" class="inline-flex items-center rounded-r-xl border border-l-0 border-slate-300 bg-slate-200 px-4 py-2 text-sm font-bold text-slate-600 hover:bg-slate-300 transition-colors">ê¸°ë¡</button>
                        </div>
                    </div>
                    <div>
                        <label for="keyword-input" class="block text-sm font-medium text-slate-600">ë‹¨ì–´ ê²€ìƒ‰ (ì—¬ëŸ¬ ë‹¨ì–´ëŠ” ë„ì–´ì“°ê¸°ë¡œ êµ¬ë¶„)</label>
                        <div class="mt-1 flex rounded-xl shadow-sm">
                            <input type="text" id="keyword-input" class="flex-1 block w-full rounded-none rounded-l-xl border-slate-300 focus:border-teal-500 focus:ring-teal-500 sm:text-sm p-3" placeholder="ì²œì§€ ì°½ì¡°">
                            <button id="keyword-search-btn" class="inline-flex items-center rounded-r-xl border border-l-0 border-teal-500 bg-teal-500 px-5 py-2 text-sm font-bold text-white hover:bg-teal-600 transition-colors">ê²€ìƒ‰</button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label for="custom-text-input" class="block text-sm font-medium text-slate-600">ì‚¬ìš©ì ë¬¸êµ¬ ì…ë ¥</label>
                    <div class="mt-1 flex rounded-xl shadow-sm">
                        <textarea id="custom-text-input" rows="2" class="flex-1 block w-full rounded-none rounded-l-xl border-slate-300 focus:border-pink-500 focus:ring-pink-500 sm:text-sm p-3" placeholder="í™”ë©´ì— ë„ìš¸ ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <button id="display-custom-text-btn" class="inline-flex items-center rounded-r-xl border border-l-0 border-pink-500 bg-pink-500 px-5 py-2 text-sm font-bold text-white hover:bg-pink-600 transition-colors">ë„ìš°ê¸°</button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-600">ë³´ì¡° ëª¨ë‹ˆí„° ë¯¸ë¦¬ë³´ê¸° (ìŠ¤í¬ë¡¤ ë™ê¸°í™”)</label>
                    <div id="preview-display" class="mt-1 bg-slate-900 text-white p-4 rounded-xl border border-slate-700 text-left flex">
                        <div id="preview-content-wrapper" class="w-full">
                            <div id="preview-content" class="flex items-center justify-center h-full">
                                <p class="text-slate-400">ë³´ì¡° ëª¨ë‹ˆí„°ì— í‘œì‹œë  ë‚´ìš©ì´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="search-result-container">
                    <label class="block text-sm font-medium text-slate-600">ê²€ìƒ‰ ê²°ê³¼</label>
                    <div id="search-result-display" class="mt-1 bg-sky-50/50 p-4 rounded-xl border border-sky-200 text-left">
                        <p class="text-slate-500 text-center">ì´ê³³ì— ë‹¨ì–´ ê²€ìƒ‰ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                
                <div id="selection-controls" class="hidden text-center">
                    <button id="display-checked-btn" class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                        ì²´í¬í•œ ë§ì”€ ë„ìš°ê¸°
                    </button>
                </div>

                <div id="reference-section" class="flex space-x-2 pt-4 border-t border-sky-100">
                    <button id="open-reference-btn" class="flex-1 bg-indigo-100 text-indigo-800 font-semibold py-2 px-4 rounded-xl hover:bg-indigo-200 transition-colors">
                        ì°¸ê³  ë§ì”€
                    </button>
                    <button id="open-reference-manager-btn" class="flex-1 bg-rose-100 text-rose-800 font-semibold py-2 px-4 rounded-xl hover:bg-rose-200 transition-colors">
                        ì°¸ê³  ë§ì”€ ê´€ë¦¬
                    </button>
                </div>

                <div class="pt-6 border-t border-sky-100">
                    <h3 class="text-lg font-semibold text-slate-700 mb-2">ë‹¨ì–´ ê°•ì¡°</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="highlight-input" class="text-sm font-medium text-slate-700">ê°•ì¡°í•  ë‹¨ì–´ (ë„ì–´ì“°ê¸°ë¡œ êµ¬ë¶„)</label>
                            <input type="text" id="highlight-input" placeholder="ì˜ˆ: í•˜ë‚˜ë‹˜ ì‚¬ë‘" class="mt-1 w-full border-slate-300 rounded-md shadow-sm p-2 focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="flex items-center justify-between space-x-4">
                            <div class="flex items-center space-x-2">
                                <label for="highlight-color" class="text-sm">ìƒ‰ìƒ:</label>
                                <input type="color" id="highlight-color" value="#FFD700" class="w-10 h-8 p-0 border-none rounded">
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="highlight-bold" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="highlight-bold" class="ml-2 text-sm">êµµê²Œ</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="highlight-italic" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="highlight-italic" class="ml-2 text-sm">ì´íƒ¤ë¦­</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="highlight-underline" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="highlight-underline" class="ml-2 text-sm">ë°‘ì¤„</label>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                             <button id="apply-highlight-btn" class="flex-1 bg-green-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-green-600">ì ìš© (Enter)</button>
                             <button id="remove-highlight-btn" class="flex-1 bg-red-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-red-600">ê°•ì¡° ì œê±°</button>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-4 pt-6 border-t border-sky-100">
                    <button id="open-style-modal-btn" class="flex-1 bg-amber-100 text-amber-800 font-semibold py-2 px-4 rounded-xl hover:bg-amber-200 transition-colors">
                        ìŠ¤íƒ€ì¼ ì„¤ì •
                    </button>
                    <button id="reopen-window-btn" class="flex-1 bg-sky-100 text-sky-800 font-semibold py-2 px-4 rounded-xl hover:bg-sky-200 transition-colors">
                        ë§ì”€ì°½ ë„ìš°ê¸°
                    </button>
                    <button id="open-guide-modal-btn" class="flex-1 bg-slate-100 text-slate-700 font-semibold py-2 px-4 rounded-xl hover:bg-slate-200 transition-colors">
                        ì‚¬ìš© ì•ˆë‚´
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="style-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md space-y-4">
            <div>
                <h3 class="text-xl font-bold text-slate-800">ë§ì”€ ìŠ¤íƒ€ì¼ ì„¤ì •</h3>
                <div class="space-y-3 mt-4">
                    <div>
                        <label for="font-size-slider" class="block text-sm font-medium text-slate-700">ê¸€ì í¬ê¸°: <span id="font-size-value" class="font-bold text-blue-600">72</span>px</label>
                        <input id="font-size-slider" type="range" min="20" max="150" value="72" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    </div>
                    <div>
                        <label for="line-height-slider" class="block text-sm font-medium text-slate-700">ì¤„ ê°„ê²©: <span id="line-height-value" class="font-bold text-blue-600">1.5</span></label>
                        <input id="line-height-slider" type="range" min="1" max="3" value="1.5" step="0.1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    </div>
                </div>
            </div>
            <div class="border-t pt-4">
                   <h3 class="text-xl font-bold text-slate-800">ì‚¬ìš©ì ë¬¸êµ¬ ìŠ¤íƒ€ì¼ ì„¤ì •</h3>
                   <div class="space-y-4 mt-4">
                       <div>
                           <label for="custom-text-font-size-slider" class="block text-sm font-medium text-slate-700">ê¸€ì í¬ê¸°: <span id="custom-text-font-size-value" class="font-bold text-pink-600">72</span>px</label>
                           <input id="custom-text-font-size-slider" type="range" min="20" max="300" value="72" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-pink-500">
                       </div>
                       <div class="flex items-center space-x-2">
                           <label for="custom-text-color" class="text-sm font-medium text-slate-700">ê¸€ì ìƒ‰ìƒ:</label>
                           <input type="color" id="custom-text-color" value="#FFFFFF" class="w-10 h-8 p-0 border-none rounded">
                       </div>
                       <div>
                           <label class="block text-sm font-medium text-slate-700 mb-2">ê°€ë¡œ ì •ë ¬</label>
                           <div id="custom-text-align-group" class="flex rounded-lg shadow-sm">
                               <button data-align="left" class="align-btn flex-1 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-l-lg hover:bg-slate-300">ì™¼ìª½</button>
                               <button data-align="center" class="align-btn flex-1 bg-slate-200 text-slate-700 font-semibold py-2 px-4 border-x border-slate-300 hover:bg-slate-300 active">ê°€ìš´ë°</button>
                               <button data-align="right" class="align-btn flex-1 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-r-lg hover:bg-slate-300">ì˜¤ë¥¸ìª½</button>
                           </div>
                       </div>
                       <div>
                           <label class="block text-sm font-medium text-slate-700 mb-2">ì„¸ë¡œ ì •ë ¬</label>
                           <div id="custom-text-valign-group" class="flex rounded-lg shadow-sm">
                               <button data-valign="flex-start" class="align-btn flex-1 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-l-lg hover:bg-slate-300">ìœ„</button>
                               <button data-valign="center" class="align-btn flex-1 bg-slate-200 text-slate-700 font-semibold py-2 px-4 border-x border-slate-300 hover:bg-slate-300 active">ì¤‘ê°„</button>
                               <button data-valign="flex-end" class="align-btn flex-1 bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-r-lg hover:bg-slate-300">ì•„ë˜</button>
                           </div>
                       </div>
                   </div>
            </div>
            <div class="text-right border-t pt-4">
                <button id="close-style-modal-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <div id="history-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-2xl space-y-4">
              <h3 class="text-xl font-bold text-slate-800">ê²€ìƒ‰ ê¸°ë¡</h3>
              <div id="history-list" class="bg-slate-100 p-2 rounded-lg border"></div>
              <div class="text-right">
                    <button id="close-history-modal-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="guide-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg space-y-4 overflow-y-auto" style="max-height: 90vh;">
              <h3 class="text-xl font-bold text-slate-800">ğŸ’¡ ì‚¬ìš© ì•ˆë‚´</h3>
              <ol class="list-decimal list-inside space-y-2 text-slate-700">
                  <li>'KOR.db íŒŒì¼ ì„ íƒí•˜ê¸°'ë¥¼ ëˆŒëŸ¬ ì„±ê²½ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</li>
                  <li>'ë§ì”€ ì°½ ì—´ê¸°'ë¥¼ ëˆŒëŸ¬ ìƒˆ ì°½ì„ ë„ìš´ í›„ ë³´ì¡° ëª¨ë‹ˆí„°ë¡œ ì˜®ê¹ë‹ˆë‹¤.</li>
                  <li>'ê¸°ë¡' ë²„íŠ¼ìœ¼ë¡œ ê²€ìƒ‰í–ˆë˜ ë§ì”€ê³¼ ë‚´ìš©ì„ í™•ì¸í•˜ê³ , 'ë°˜ì˜' ë²„íŠ¼ìœ¼ë¡œ ì°¸ê³  ë§ì”€ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                  <li>'ì°¸ê³  ë§ì”€' ë²„íŠ¼ìœ¼ë¡œ 'ì „ë„/ìƒí™œìƒë‹´' í† ê¸€ì„ í´ë¦­í•´ ì£¼ì œë³„ ë§ì”€ì„ í™•ì¸í•˜ê³  ë°”ë¡œ ë„ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                  <li>'ì°¸ê³  ë§ì”€ ê´€ë¦¬' ë²„íŠ¼ìœ¼ë¡œ ë‚˜ë§Œì˜ ì£¼ì œë³„ ë§ì”€ì„ 'ì „ë„/ìƒí™œìƒë‹´' í† ê¸€ì— ë§ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                  <li>'ìŠ¤íƒ€ì¼ ì„¤ì •' ë° 'ë‹¨ì–´ ê°•ì¡°' ê¸°ëŠ¥ìœ¼ë¡œ ìŠ¤íƒ€ì¼ì„ ê¾¸ë°€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                  <li>ë§ì”€ ì°½ì—ì„œ í‚¤ë³´ë“œ ë°©í–¥í‚¤(â†, â†’) ë˜ëŠ” <b>í™”ë©´ì˜ í™”ì‚´í‘œ ë²„íŠ¼</b>ìœ¼ë¡œ ì´ì „/ë‹¤ìŒ êµ¬ì ˆë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                  <li>ë§ì”€ ì°½ì—ì„œ <b>Shift + ë°©í–¥í‚¤</b>(â†, â†’)ë¡œ êµ¬ì ˆ ë²”ìœ„ë¥¼ ì¡°ì ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
              </ol>

              <div class="border-t pt-4 mt-4">
                  <h4 class="text-lg font-bold text-slate-800 mb-2">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h4>
                  <div class="space-y-2">
                      <div>
                          <label for="current-password-input" class="text-sm">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                          <input type="password" id="current-password-input" class="mt-1 w-full border-slate-300 rounded-md shadow-sm p-2">
                      </div>
                      <div>
                          <label for="new-password-input" class="text-sm">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                          <input type="password" id="new-password-input" class="mt-1 w-full border-slate-300 rounded-md shadow-sm p-2">
                      </div>
                      <div>
                          <label for="confirm-password-input" class="text-sm">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                          <input type="password" id="confirm-password-input" class="mt-1 w-full border-slate-300 rounded-md shadow-sm p-2">
                      </div>
                      <button id="change-password-btn" class="w-full bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 mt-2">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                  </div>
              </div>

              <div class="text-right border-t pt-4 mt-4">
                  <button id="close-guide-modal-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">í™•ì¸</button>
              </div>
        </div>
    </div>

    <div id="add-to-reference-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md space-y-4">
              <h3 class="text-xl font-bold text-slate-800">ì°¸ê³  ë§ì”€ì— ì¶”ê°€</h3>
              <p class="text-sm text-slate-600">ì„ íƒí•œ ê¸°ë¡ì„ ì–´ëŠ ì¹´í…Œê³ ë¦¬ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
              <div id="add-to-reference-form" class="space-y-4">
                  <div>
                      <label for="reference-sheet-select" class="block text-sm font-medium text-slate-700">ìƒë‹´ ì‹œíŠ¸ ì„ íƒ</label>
                      <select id="reference-sheet-select" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                          <option value="evangelism">ì „ë„ìƒë‹´</option>
                          <option value="life">ìƒí™œìƒë‹´</option>
                      </select>
                  </div>
                  <div>
                    <label for="reference-category-select" class="block text-sm font-medium text-slate-700">ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                    <select id="reference-category-select" class="mt-1 block w-full p-2 border border-slate-300 rounded-md"></select>
                  </div>
                  <div>
                    <label for="new-reference-category-input" class="block text-sm font-medium text-slate-700">ë˜ëŠ” ìƒˆ ì¹´í…Œê³ ë¦¬ ì…ë ¥</label>
                    <input type="text" id="new-reference-category-input" placeholder="ìƒˆ ì¹´í…Œê³ ë¦¬ ì´ë¦„" class="mt-1 block w-full p-2 border border-slate-300 rounded-md">
                  </div>
              </div>
              <div class="flex justify-end space-x-2 border-t pt-4">
                <button id="add-to-reference-save-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">ì €ì¥</button>
                <button id="add-to-reference-cancel-btn" class="bg-slate-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-600">ì·¨ì†Œ</button>
              </div>
        </div>
    </div>
    
    <div id="generic-modal" class="modal fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center p-4 z-[100]">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm space-y-4">
            <h3 id="generic-modal-title" class="text-xl font-bold text-slate-800">ì•Œë¦¼</h3>
            <p id="generic-modal-message" class="text-slate-600"></p>
            <div id="generic-modal-buttons" class="flex justify-end space-x-2 border-t pt-4"></div>
        </div>
    </div>

    <script>
    // App's main scope, wrapped in an IIFE to prevent global scope pollution.
    (function() {
        'use strict';

        /**
         * Configuration object for static values.
         */
        const config = {
            defaultPassword: '1234',
            bibleAbbrCsv: `ìˆœë²ˆ,êµ¬ë¶„,ì•½ì
1,ì°½ì„¸ê¸°,ì°½
2,ì¶œì• êµ½ê¸°,ì¶œ
3,ë ˆìœ„ê¸°,ë ˆ
4,ë¯¼ìˆ˜ê¸°,ë¯¼
5,ì‹ ëª…ê¸°,ì‹ 
6,ì—¬í˜¸ìˆ˜ì•„,ìˆ˜
7,ì‚¬ì‚¬ê¸°,ì‚¿
8,ë£»ê¸°,ë£»
9,ì‚¬ë¬´ì—˜ìƒ,ì‚¼ìƒ
10,ì‚¬ë¬´ì—˜í•˜,ì‚¼í•˜
11,ì—´ì™•ê¸°ìƒ,ì™•ìƒ
12,ì—´ì™•ê¸°í•˜,ì™•í•˜
13,ì—­ëŒ€ìƒ,ëŒ€ìƒ
14,ì—­ëŒ€í•˜,ëŒ€í•˜
15,ì—ìŠ¤ë¼,ìŠ¤
16,ëŠí—¤ë¯¸ì•¼,ëŠ
17,ì—ìŠ¤ë”,ì—
18,ìš¥ê¸°,ìš¥
19,ì‹œí¸,ì‹œ
20,ì ì–¸,ì 
21,ì „ë„ì„œ,ì „
22,ì•„ê°€,ì•„
23,ì´ì‚¬ì•¼,ì‚¬
24,ì˜ˆë ˆë¯¸ì•¼,ë ˜
25,ì˜ˆë ˆë¯¸ì•¼ì• ê°€,ì• 
26,ì—ìŠ¤ê²”,ê²”
27,ë‹¤ë‹ˆì—˜,ë‹¨
28,í˜¸ì„¸ì•„,í˜¸
29,ìš”ì—˜,ìšœ
30,ì•„ëª¨ìŠ¤,ì•”
31,ì˜¤ë°”ëŒœ,ì˜µ
32,ìš”ë‚˜,ìš˜
33,ë¯¸ê°€,ë¯¸
34,ë‚˜í›”,ë‚˜
35,í•˜ë°•êµ­,í•©
36,ìŠ¤ë°”ëƒ,ìŠµ
37,í•™ê°œ,í•™
38,ìŠ¤ê°€ë´,ìŠ¥
39,ë§ë¼ê¸°,ë§
40,ë§ˆíƒœë³µìŒ,ë§ˆ
41,ë§ˆê°€ë³µìŒ,ë§‰
42,ëˆ„ê°€ë³µìŒ,ëˆ…
43,ìš”í•œë³µìŒ,ìš”
44,ì‚¬ë„í–‰ì „,í–‰
45,ë¡œë§ˆì„œ,ë¡¬
46,ê³ ë¦°ë„ì „ì„œ,ê³ ì „
47,ê³ ë¦°ë„í›„ì„œ,ê³ í›„
48,ê°ˆë¼ë””ì•„ì„œ,ê°ˆ
49,ì—ë² ì†Œì„œ,ì—¡
50,ë¹Œë¦½ë³´ì„œ,ë¹Œ
51,ê³¨ë¡œìƒˆì„œ,ê³¨
52,ë°ì‚´ë¡œë‹ˆê°€ì „ì„œ,ì‚´ì „
53,ë°ì‚´ë¡œë‹ˆê°€í›„ì„œ,ì‚´í›„
54,ë””ëª¨ë°ì „ì„œ,ë”¤ì „
55,ë””ëª¨ë°í›„ì„œ,ë”¤í›„
56,ë””ë„ì„œ,ë”›
57,ë¹Œë ˆëª¬ì„œ,ëª¬
58,íˆë¸Œë¦¬ì„œ,íˆ
59,ì•¼ê³ ë³´ì„œ,ì•½
60,ë² ë“œë¡œì „ì„œ,ë²§ì „
61,ë² ë“œë¡œí›„ì„œ,ë²§í›„
62,ìš”í•œ1ì„œ,ìš”ì¼
63,ìš”í•œ2ì„œ,ìš”ì´
64,ìš”í•œ3ì„œ,ìš”ì‚¼
65,ìœ ë‹¤ì„œ,ìœ 
66,ìš”í•œê³„ì‹œë¡,ê³„`,
            defaultReferenceVerses: {
                evangelism: { "êµ¬ì›": ["ìš” 3:16", "ë¡¬ 10:9-10", "ì—¡ 2:8-9"], "ì‚¬ë‘": ["ê³ ì „ 13:4-7", "ìš”ì¼ 4:7-8", "ìš” 13:34-35"], "ë¯¿ìŒ": ["íˆ 11:1", "íˆ 11:6", "ë¡¬ 1:17", "ë§‰ 9:23"], },
                life: { "ê¸°ë„": ["ë§ˆ 7:7-8", "ë¹Œ 4:6-7", "ë ˜ 33:3"], "ê°ì‚¬": ["ì‚´ì „ 5:16-18", "ì‹œ 100:4-5"] }
            }
        };

        /**
         * Holds the application's dynamic state.
         */
        const state = {
            displayWindow: null,
            referenceWindow: null,
            referenceManagerWindow: null,
            db: null,
            bookInfoMap: {},
            bookLookupMap: {},
            verseParsingRegex: null,
            lastQueryResult: null,
            checkedVerses: [],
            isMultiSelectMode: false,
            historyStack: [],
            forwardStack: [],
            searchHistory: [],
            customTextAlign: 'center',
            customVerticalAlign: 'center',
            referenceVerses: {},
            logoSrc: null
        };

        /**
         * Caches all necessary DOM elements for performance.
         */
        const dom = {};
        function cacheDomElements() {
            const ids = [
                'password-modal', 'password-input', 'password-submit-btn', 'db-loader', 'db-file-input', 'db-status',
                'logo-file-input', 'logo-status', 'main-content', 'initial-view', 'open-window-btn', 'control-panel',
                'prev-verse-btn', 'next-verse-btn', 'verse-input', 'display-btn', 'open-history-modal-btn', 'keyword-input',
                'keyword-search-btn', 'custom-text-input', 'display-custom-text-btn', 'preview-display', 'preview-content-wrapper',
                'preview-content', 'search-result-container', 'search-result-display', 'selection-controls', 'display-checked-btn',
                'reference-section', 'open-reference-btn', 'open-reference-manager-btn', 'highlight-input', 'highlight-color',
                'highlight-bold', 'highlight-italic', 'highlight-underline', 'apply-highlight-btn', 'remove-highlight-btn',
                'open-style-modal-btn', 'reopen-window-btn', 'open-guide-modal-btn', 'style-modal', 'font-size-slider',
                'font-size-value', 'line-height-slider', 'line-height-value', 'custom-text-font-size-slider', 'custom-text-font-size-value',
                'custom-text-color', 'custom-text-align-group', 'custom-text-valign-group', 'close-style-modal-btn',
                'history-modal', 'history-list', 'close-history-modal-btn', 'guide-modal', 'close-guide-modal-btn',
                'current-password-input', 'new-password-input', 'confirm-password-input', 'change-password-btn',
                'add-to-reference-modal', 'add-to-reference-form', 'reference-sheet-select', 'reference-category-select',
                'new-reference-category-input', 'add-to-reference-save-btn', 'add-to-reference-cancel-btn', 'generic-modal',
                'generic-modal-title', 'generic-modal-message', 'generic-modal-buttons'
            ];
            ids.forEach(id => dom[id] = document.getElementById(id));
        }

        /**
         * Core application logic and utilities.
         */
        const core = {
            initializeDatabase: async function(file) {
                dom['db-status'].textContent = 'ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì½ëŠ” ì¤‘...';
                try {
                    const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}` });
                    const fileBuffer = await file.arrayBuffer();
                    state.db = new SQL.Database(new Uint8Array(fileBuffer));
                    core.buildBookAbbrMapsFromCsv();
                    dom['db-loader'].classList.add('hidden');
                    dom['main-content'].classList.remove('hidden');
                    dom['db-status'].textContent = 'ë°ì´í„°ë² ì´ìŠ¤ ë¡œë”© ì™„ë£Œ!';
                } catch (error) {
                    console.error("Database load failed:", error);
                    dom['db-status'].innerHTML = `<p class="text-red-500">ë°ì´í„°ë² ì´ìŠ¤ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: ${error.message}</p>`;
                }
            },

            buildBookAbbrMapsFromCsv: function() {
                const lines = config.bibleAbbrCsv.split('\n').slice(1);
                lines.forEach(row => {
                    const [bookId, name, abbr] = row.split(',');
                    if (!bookId || !name || !abbr) return;
                    const id = parseInt(bookId, 10);
                    state.bookInfoMap[id] = { name: name.trim(), abbr: abbr.trim() };
                    state.bookLookupMap[name.trim().toLowerCase()] = id;
                    state.bookLookupMap[abbr.trim().toLowerCase()] = id;
                });
                const bookNamesAndAbbrs = Object.keys(state.bookLookupMap).sort((a, b) => b.length - a.length);
                const bookRegexPart = `(${bookNamesAndAbbrs.join('|')})`;
                state.verseParsingRegex = new RegExp(`^${bookRegexPart}[\\s\\.]*(\\d+)[\\s]*[:\\.]?[\\s]*(\\d+)(?:[\\s-]*(\\d+))?$`, 'i');
            },

            parseVerseReference: function(ref) {
                if (!ref || !state.verseParsingRegex) return null;
                const match = ref.trim().match(state.verseParsingRegex);
                if (!match) return null;
                const bookName = match[1].toLowerCase();
                const chapter = parseInt(match[2], 10);
                const startVerse = parseInt(match[3], 10);
                const endVerse = match[4] ? parseInt(match[4], 10) : startVerse;
                const bookId = state.bookLookupMap[bookName];
                if (!bookId || isNaN(chapter) || isNaN(startVerse)) return null;
                return { bookId, bookName: state.bookInfoMap[bookId].name, chapter, startVerse, endVerse };
            },

            queryBible: function(parsedRef) {
                if (!state.db || !parsedRef) return null;
                try {
                    const maxVerseStmt = state.db.prepare("SELECT MAX(verse) as max_verse FROM clause WHERE book = :book AND chapter = :chapter");
                    maxVerseStmt.bind({ ':book': parsedRef.bookId, ':chapter': parsedRef.chapter });
                    let maxVerse = maxVerseStmt.step() ? maxVerseStmt.getAsObject().max_verse : null;
                    maxVerseStmt.free();

                    if (maxVerse === null) return null;
                    let adjustedStartVerse = Math.min(parsedRef.startVerse, maxVerse);
                    let adjustedEndVerse = Math.min(parsedRef.endVerse, maxVerse);
                    if (adjustedStartVerse > adjustedEndVerse) adjustedEndVerse = adjustedStartVerse;

                    const stmt = state.db.prepare("SELECT verse, text FROM clause WHERE book = :book AND chapter = :chapter AND verse >= :startVerse AND verse <= :endVerse ORDER BY verse");
                    stmt.bind({ ':book': parsedRef.bookId, ':chapter': parsedRef.chapter, ':startVerse': adjustedStartVerse, ':endVerse': adjustedEndVerse });
                    
                    const verses = [];
                    while (stmt.step()) {
                        verses.push({ book: parsedRef.bookId, chapter: parsedRef.chapter, ...stmt.getAsObject() });
                    }
                    stmt.free();

                    if (verses.length === 0) return null;
                    const finalStartVerse = verses[0].verse;
                    const finalEndVerse = verses[verses.length - 1].verse;
                    const address = finalStartVerse === finalEndVerse
                        ? `${parsedRef.bookName} ${parsedRef.chapter}:${finalStartVerse}`
                        : `${parsedRef.bookName} ${parsedRef.chapter}:${finalStartVerse}-${finalEndVerse}`;
                    return { verses, address };
                } catch (error) { console.error("Bible query error:", error); return null; }
            },

            queryByKeyword: function(searchTerm) {
                if (!state.db || !searchTerm) return [];
                const keywords = searchTerm.trim().split(' ').filter(k => k);
                if (keywords.length === 0) return [];
                const whereClause = keywords.map(() => `text LIKE ?`).join(' AND ');
                const params = keywords.map(k => `%${k}%`);
                const sql = `SELECT book, chapter, verse, text FROM clause WHERE ${whereClause} ORDER BY book, chapter, verse LIMIT 100`;
                try {
                    const stmt = state.db.prepare(sql);
                    stmt.bind(params);
                    const results = [];
                    while (stmt.step()) {
                        results.push(stmt.getAsObject());
                    }
                    stmt.free();
                    return results;
                } catch (error) {
                    console.error("Keyword search error:", error);
                    dom['search-result-display'].innerHTML = '<p class="text-center text-red-500">ë‹¨ì–´ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
                    return [];
                }
            },

            loadReferenceVerses: function() {
                const savedData = localStorage.getItem('bibleProjectReferenceVerses');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        if (parsedData && parsedData.evangelism === undefined && parsedData.life === undefined) {
                            state.referenceVerses = { evangelism: parsedData, life: {} };
                            core.saveReferenceData(state.referenceVerses);
                        } else {
                            state.referenceVerses = parsedData || config.defaultReferenceVerses;
                        }
                    } catch (e) {
                        console.error("Error parsing reference verses from localStorage", e);
                        state.referenceVerses = config.defaultReferenceVerses;
                    }
                } else {
                    state.referenceVerses = config.defaultReferenceVerses;
                }
            },

            saveReferenceData: function(data) {
                localStorage.setItem('bibleProjectReferenceVerses', JSON.stringify(data));
                state.referenceVerses = data;
            },
        };

        /**
         * Functions that handle UI updates and rendering.
         */
        const ui = {
            showNotification: function(message, title = 'ì•Œë¦¼') {
                dom['generic-modal-title'].textContent = title;
                dom['generic-modal-message'].textContent = message;
                dom['generic-modal-buttons'].innerHTML = `<button id="generic-modal-ok" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">í™•ì¸</button>`;
                dom['generic-modal'].classList.remove('hidden');
                dom['generic-modal'].classList.add('flex');
                document.getElementById('generic-modal-ok').onclick = () => {
                    dom['generic-modal'].classList.add('hidden');
                    dom['generic-modal'].classList.remove('flex');
                };
            },

            showConfirmation: function(message, callback, title = 'í™•ì¸') {
                dom['generic-modal-title'].textContent = title;
                dom['generic-modal-message'].textContent = message;
                dom['generic-modal-buttons'].innerHTML = `
                    <button id="generic-modal-yes" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">ì˜ˆ</button>
                    <button id="generic-modal-no" class="bg-slate-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-600">ì•„ë‹ˆìš”</button>`;
                dom['generic-modal'].classList.remove('hidden');
                dom['generic-modal'].classList.add('flex');
                const close = (result) => {
                    dom['generic-modal'].classList.add('hidden');
                    dom['generic-modal'].classList.remove('flex');
                    if (callback) callback(result);
                };
                document.getElementById('generic-modal-yes').onclick = () => close(true);
                document.getElementById('generic-modal-no').onclick = () => close(false);
            },

            openDisplayWindow: function() {
                if (state.displayWindow && !state.displayWindow.closed) {
                    state.displayWindow.focus();
                    return;
                }
                const width = 800, height = 600;
                const left = (screen.width/2)-(width/2) + screen.width;
                const top = (screen.height/2)-(height/2);
                state.displayWindow = window.open('', 'BibleDisplayWindow', `width=${width},height=${height},top=${top},left=${left}`);
                
                if (state.displayWindow) {
                    let initialContent = state.logoSrc
                        ? `<img src="${state.logoSrc}" alt="Bible" style="max-width: 50%; max-height: 50%; object-fit: contain; display: inline-block;">`
                        : `<h1 style="font-size:72px;line-height:1.5;text-shadow:2px 2px 8px rgba(255,255,255,0.3);">ì„±ê²½</h1>`;
                    
                    state.displayWindow.document.write(`
                        <!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>ë§ì”€</title>
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@600&display=swap" rel="stylesheet">
                        <style>
                            body { font-family:'Noto Serif KR',serif; -webkit-overflow-scrolling: touch; } 
                            #verse-container { transition:opacity 0.3s ease-in-out; }
                            ::-webkit-scrollbar { width:10px; } ::-webkit-scrollbar-track { background:#1f2937; }
                            ::-webkit-scrollbar-thumb { background:#4b5563; border-radius:5px; } ::-webkit-scrollbar-thumb:hover { background:#6b7280; }
                            .nav-btn {
                                position: fixed; top: 50%; transform: translateY(-50%);
                                background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
                                color: white; width: 44px; height: 44px; border-radius: 50%;
                                font-size: 24px; display: flex; align-items: center; justify-content: center;
                                cursor: pointer; transition: background-color 0.2s; user-select: none;
                            }
                            .nav-btn:hover { background-color: rgba(255, 255, 255, 0.3); }
                            #nav-prev { left: 20px; }
                            #nav-next { right: 20px; }
                        </style></head>
                        <body class="bg-black text-white h-screen overflow-y-auto p-12 flex items-center justify-center">
                        <div id="verse-container" class="w-full text-center">
                            <div id="verse-text">${initialContent}</div>
                            <div id="verse-address"><p class="text-2xl mt-4 text-gray-300 text-center"></p></div>
                        </div>
                        <button id="nav-prev" class="nav-btn" title="ì´ì „ êµ¬ì ˆ (â†)">&lt;</button>
                        <button id="nav-next" class="nav-btn" title="ë‹¤ìŒ êµ¬ì ˆ (â†’)">&gt;</button>
                        <script>
                            document.addEventListener('keydown', (e) => {
                                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                                    e.preventDefault();
                                    if (window.opener && window.opener.appInterface) {
                                        window.opener.appInterface.navigateVerseByKey(e);
                                    }
                                }
                            });
                            document.getElementById('nav-prev').addEventListener('click', () => {
                                if (window.opener && window.opener.appInterface) window.opener.appInterface.navigateVerseByClick('prev');
                            });
                            document.getElementById('nav-next').addEventListener('click', () => {
                                if (window.opener && window.opener.appInterface) window.opener.appInterface.navigateVerseByClick('next');
                            });
                        <\/script></body></html>`);
                    state.displayWindow.document.close();
                    dom['initial-view'].classList.add('hidden');
                    dom['control-panel'].classList.remove('hidden');
                } else {
                    ui.showNotification('íŒì—… ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì´ ì‚¬ì´íŠ¸ì˜ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'ì˜¤ë¥˜');
                }
            },

            formatVerseHtml: function(verses, highlightInfo, isMulti = false) {
                return verses.map(v => {
                    let verseText = v.text;
                    if (highlightInfo && highlightInfo.words.length > 0) {
                        const regex = new RegExp(highlightInfo.words.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|'), 'g');
                        verseText = verseText.replace(regex, match => `<span style="${highlightInfo.style}">${match}</span>`);
                    }
                    if (v.type === 'custom') {
                        return `<p class="custom-text-line">${verseText.replace(/\n/g, '<br>')}</p>`;
                    }
                    if (isMulti) {
                        const bookName = state.bookInfoMap[v.book].name;
                        const fullAddress = `${bookName} ${v.chapter}:${v.verse}`;
                        return `<div class="mb-4"><p class="flex items-baseline"><span class="verse-number text-sky-500 font-normal mr-4">${v.verse}</span><span class="verse-text-content">${verseText}</span></p><p class="multi-verse-full-address text-right text-sm text-amber-400/80 mt-1 pr-2">${fullAddress}</p></div>`;
                    } else {
                        return `<p class="flex items-baseline"><span class="verse-number text-sky-500 font-normal mr-4">${v.verse}</span><span class="verse-text-content">${verseText}</span></p>`;
                    }
                }).join('');
            },

            updatePreviewDisplay: function(verseHtml, address) {
                const previewAddressHtml = address ? `<h2 class="text-base mt-4 text-amber-300">${address}</h2>` : '';
                dom['preview-content-wrapper'].innerHTML = `<div id="preview-content">${verseHtml}</div><div id="preview-address">${previewAddressHtml}</div>`;
            },

            updateSecondaryMonitor: function(verseHtml, address) {
                if (!state.displayWindow || state.displayWindow.closed) return;
                const verseTextDiv = state.displayWindow.document.getElementById('verse-text');
                const verseAddressDiv = state.displayWindow.document.getElementById('verse-address');
                const verseContainer = state.displayWindow.document.getElementById('verse-container');
                if (verseContainer) {
                    verseContainer.style.opacity = 0;
                    setTimeout(() => {
                        verseTextDiv.innerHTML = verseHtml;
                        verseAddressDiv.innerHTML = address ? `<h2 class="text-3xl md:text-4xl mt-8 text-amber-300">${address}</h2>` : '';
                        ui.updateAllStyles();
                        verseContainer.style.opacity = 1;
                    }, 300);
                }
                state.displayWindow.focus();
            },

            updateAllStyles: function() {
                if (!state.lastQueryResult) return;
                const isCustom = state.lastQueryResult.verses[0]?.type === 'custom';
                isCustom ? ui.updateCustomTextStyles() : ui.updateBibleStyles();
            },

            updateBibleStyles: function() {
                const newSize = dom['font-size-slider'].value;
                const newLh = dom['line-height-slider'].value;
                dom['font-size-value'].textContent = newSize;
                dom['line-height-value'].textContent = newLh;

                if (state.displayWindow && !state.displayWindow.closed) {
                    const body = state.displayWindow.document.body;
                    const verseTextDiv = state.displayWindow.document.getElementById('verse-text');
                    if (body && verseTextDiv) {
                        body.style.alignItems = '';
                        verseTextDiv.style.textAlign = 'left';
                        verseTextDiv.style.color = 'white';
                        verseTextDiv.style.fontSize = `${newSize}px`;
                        verseTextDiv.style.lineHeight = newLh;
                        verseTextDiv.querySelectorAll('.verse-number').forEach(s => s.style.fontSize = `${Math.max(12, newSize * 0.5)}px`);
                        verseTextDiv.querySelectorAll('.multi-verse-full-address').forEach(p => p.style.fontSize = `${Math.max(10, newSize * 0.4)}px`);
                    }
                }
                const previewContent = dom['preview-content'];
                if (previewContent) {
                    dom['preview-display'].style.alignItems = '';
                    previewContent.style.textAlign = 'left';
                    previewContent.style.color = 'white';
                    const previewFontSize = Math.max(12, newSize / 5);
                    previewContent.style.fontSize = `${previewFontSize}px`;
                    previewContent.style.lineHeight = newLh;
                    previewContent.querySelectorAll('.verse-number').forEach(s => s.style.fontSize = `${Math.max(8, previewFontSize * 0.8)}px`);
                    previewContent.querySelectorAll('.multi-verse-full-address').forEach(p => p.style.fontSize = `${Math.max(7, previewFontSize * 0.7)}px`);
                }
            },

            updateCustomTextStyles: function() {
                const newSize = dom['custom-text-font-size-slider'].value;
                const newColor = dom['custom-text-color'].value;
                dom['custom-text-font-size-value'].textContent = newSize;

                if (state.displayWindow && !state.displayWindow.closed) {
                    const body = state.displayWindow.document.body;
                    const verseTextDiv = state.displayWindow.document.getElementById('verse-text');
                    if (body && verseTextDiv) {
                        body.style.alignItems = state.customVerticalAlign;
                        verseTextDiv.style.textAlign = state.customTextAlign;
                        verseTextDiv.style.fontSize = `${newSize}px`;
                        verseTextDiv.style.color = newColor;
                    }
                }
                const previewContent = dom['preview-content'];
                if (previewContent) {
                    dom['preview-display'].style.alignItems = state.customVerticalAlign;
                    previewContent.style.textAlign = state.customTextAlign;
                    const previewFontSize = Math.max(12, newSize / 5);
                    previewContent.style.fontSize = `${previewFontSize}px`;
                    previewContent.style.color = newColor;
                }
            },

            renderContent: function() {
                if (!state.lastQueryResult) return;
                const highlightWords = dom['highlight-input'].value.trim().split(' ').filter(k => k);
                let highlightInfo = null;
                if (highlightWords.length > 0) {
                    const hexToRgb = hex => {
                        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                        return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
                    };
                    const rgbColor = hexToRgb(dom['highlight-color'].value);
                    let style = `color: ${dom['highlight-color'].value}; padding: 0 2px; border-radius: 3px;`;
                    if (rgbColor) style += `background-color: rgba(${rgbColor}, 0.3);`;
                    if (dom['highlight-bold'].checked) style += 'font-weight: 700;';
                    if (dom['highlight-italic'].checked) style += 'font-style: italic;';
                    if (dom['highlight-underline'].checked) style += 'text-decoration: underline; text-decoration-thickness: 2px;';
                    highlightInfo = { words: highlightWords, style: style };
                }
                const verseHtml = ui.formatVerseHtml(state.lastQueryResult.verses, highlightInfo, state.isMultiSelectMode);
                ui.updatePreviewDisplay(verseHtml, state.lastQueryResult.address);
                ui.updateSecondaryMonitor(verseHtml, state.lastQueryResult.address);
            },
            
            toggleSelectionControls: function() {
                dom['selection-controls'].classList.toggle('hidden', state.checkedVerses.length === 0);
            },

            updateNavButtonStates: function() {
                dom['prev-verse-btn'].disabled = state.historyStack.length === 0;
                dom['next-verse-btn'].disabled = state.forwardStack.length === 0;
            },

            populateHistoryList: function() {
                dom['history-list'].innerHTML = '';
                if (state.searchHistory.length === 0) {
                    dom['history-list'].innerHTML = '<p class="text-slate-500 text-center p-4">ê²€ìƒ‰ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                const fragment = document.createDocumentFragment();
                state.searchHistory.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'history-item p-3 border-b border-slate-200 flex justify-between items-center';
                    div.dataset.historyIndex = index;

                    const typeLabel = { verse: 'êµ¬ì ˆ', keyword: 'ë‹¨ì–´', checked: 'ì„ íƒ', custom: 'ë¬¸êµ¬' }[item.type];
                    const displayText = item.type === 'keyword' ? `[${typeLabel}] "${item.term}"` : item.term;
                    const contentPreview = item.result?.verses?.[0]?.text.substring(0, 50) + '...' || 'ë‚´ìš© ì—†ìŒ';
                    
                    div.innerHTML = `
                        <div class="history-content-btn flex-1 cursor-pointer">
                            <p class="font-bold text-slate-800"><span class="text-sm text-blue-600">[${typeLabel}]</span> ${item.term}</p>
                            <p class="text-sm text-slate-500 mt-1">${contentPreview}</p>
                        </div>
                        <button class="add-to-ref-btn bg-indigo-100 text-indigo-700 text-sm font-semibold py-1 px-3 rounded-md hover:bg-indigo-200 ml-4"
                                ${item.type === 'custom' || item.type === 'keyword' ? 'disabled' : ''} title="ì°¸ê³  ë§ì”€ì— ì¶”ê°€">
                            ë°˜ì˜
                        </button>`;
                    fragment.appendChild(div);
                });
                dom['history-list'].appendChild(fragment);
            }
        };

        /**
         * Manages application history (undo/redo).
         */
        const history = {
            updateContent: function(newQueryResult, newIsMultiMode, historyInfo) {
                if (state.lastQueryResult) {
                    state.historyStack.push({ queryResult: state.lastQueryResult, isMulti: state.isMultiSelectMode });
                    if (state.historyStack.length > 30) state.historyStack.shift();
                }
                if (historyInfo) {
                    history.addSearchHistory(historyInfo, newQueryResult);
                }
                state.forwardStack = [];
                state.lastQueryResult = newQueryResult;
                state.isMultiSelectMode = newIsMultiMode;
                ui.renderContent();
                ui.updateNavButtonStates();
            },

            goBack: function() {
                if (state.historyStack.length === 0) return;
                state.forwardStack.push({ queryResult: state.lastQueryResult, isMulti: state.isMultiSelectMode });
                const prevState = state.historyStack.pop();
                state.lastQueryResult = prevState.queryResult;
                state.isMultiSelectMode = prevState.isMulti;
                ui.renderContent();
                ui.updateNavButtonStates();
            },

            goForward: function() {
                if (state.forwardStack.length === 0) return;
                state.historyStack.push({ queryResult: state.lastQueryResult, isMulti: state.isMultiSelectMode });
                const nextState = state.forwardStack.pop();
                state.lastQueryResult = nextState.queryResult;
                state.isMultiSelectMode = nextState.isMulti;
                ui.renderContent();
                ui.updateNavButtonStates();
            },

            addSearchHistory: function(historyInfo, queryResult) {
                if (!historyInfo || !historyInfo.term) return;
                const newHistoryItem = { type: historyInfo.type, term: historyInfo.term, result: queryResult };
                const isDuplicate = state.searchHistory.length > 0 &&
                                         state.searchHistory[0].type === newHistoryItem.type &&
                                         state.searchHistory[0].term === newHistoryItem.term;
                if (!isDuplicate) {
                    state.searchHistory.unshift(newHistoryItem);
                    if (state.searchHistory.length > 100) state.searchHistory.pop();
                }
            }
        };

        /**
         * Functions that are called directly by event listeners.
         */
        const handlers = {
            checkPassword: function() {
                const enteredPassword = dom['password-input'].value;
                const storedPassword = localStorage.getItem('bibleProjectorPassword');
                if (enteredPassword === storedPassword) {
                    dom['password-modal'].style.display = 'none';
                    dom['db-loader'].classList.remove('hidden');
                } else {
                    ui.showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
                    dom['password-input'].value = '';
                }
            },

            changePassword: function() {
                const currentPassword = dom['current-password-input'].value;
                const newPassword = dom['new-password-input'].value;
                const confirmPassword = dom['confirm-password-input'].value;
                const storedPassword = localStorage.getItem('bibleProjectorPassword');

                if (currentPassword !== storedPassword) return ui.showNotification('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                if (!newPassword) return ui.showNotification('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                if (newPassword !== confirmPassword) return ui.showNotification('ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ í™•ì¸ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                
                localStorage.setItem('bibleProjectorPassword', newPassword);
                ui.showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                dom['current-password-input'].value = '';
                dom['new-password-input'].value = '';
                dom['confirm-password-input'].value = '';
            },

            displayVerse: function() {
                handlers.clearSelection();
                const userInput = dom['verse-input'].value;
                if (!userInput) return;
                const parsedRef = core.parseVerseReference(userInput);
                if (!parsedRef) {
                    dom['preview-content-wrapper'].innerHTML = '<p class="text-center text-red-500 my-auto">ì…ë ¥ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>(ì˜ˆ: ì°½ 1:1)</p>';
                    return;
                }
                const result = core.queryBible(parsedRef);
                if (!result || result.verses.length === 0) {
                    dom['preview-content-wrapper'].innerHTML = `<p class="text-center text-red-500 my-auto">${parsedRef.bookName} ${parsedRef.chapter}:${parsedRef.startVerse} ë§ì”€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                    return;
                }
                history.updateContent(result, false, { type: 'verse', term: userInput });
            },

            performKeywordSearch: function() {
                handlers.clearSelection();
                const searchTerm = dom['keyword-input'].value;
                if (!searchTerm) return;
                history.addSearchHistory({ type: 'keyword', term: searchTerm }, null);
                const results = core.queryByKeyword(searchTerm);
                dom['search-result-display'].innerHTML = '';
                if (results.length === 0) {
                    dom['search-result-display'].innerHTML = '<p class="text-center text-slate-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                const keywords = searchTerm.trim().split(' ').filter(k => k);
                const resultHeader = document.createElement('p');
                resultHeader.className = "text-sm text-slate-600 mb-2";
                resultHeader.innerHTML = `'<strong>${searchTerm}</strong>' ê²€ìƒ‰ ê²°ê³¼: <strong>${results.length}</strong>ê°œ`;
                dom['search-result-display'].appendChild(resultHeader);
                
                const fragment = document.createDocumentFragment();
                results.forEach(verse => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item p-2 border-b border-sky-100 flex items-center';
                    let highlightedText = verse.text.replace(new RegExp(keywords.join('|'), 'g'), match => `<strong class="text-blue-600 font-bold">${match}</strong>`);
                    const bookName = state.bookInfoMap[verse.book].name;
                    const address = `${bookName} ${verse.chapter}:${verse.verse}`;
                    const verseData = { book: verse.book, chapter: verse.chapter, verse: verse.verse, text: verse.text };
                    
                    item.innerHTML = `<input type="checkbox" class="verse-checkbox h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500 mr-3 shrink-0" data-verse='${JSON.stringify(verseData)}'><div class="verse-content flex-1 cursor-pointer" data-address="${address}"><p class="font-bold text-sm text-slate-800">${address}</p><p class="text-sm text-slate-600">${highlightedText}</p></div>`;
                    fragment.appendChild(item);
                });
                dom['search-result-display'].appendChild(fragment);
            },

            displayCustomText: function() {
                handlers.clearSelection();
                const text = dom['custom-text-input'].value;
                if (!text.trim()) return;
                const newQueryResult = {
                    verses: text.split('\n').map(line => ({ text: line, type: 'custom' })),
                    address: ""
                };
                const term = text.length > 15 ? text.substring(0, 15) + '...' : text;
                history.updateContent(newQueryResult, false, { type: 'custom', term: term });
            },

            displayCheckedVerses: function() {
                if (state.checkedVerses.length === 0) return;
                state.checkedVerses.sort((a, b) => a.book - b.book || a.chapter - b.chapter || a.verse - b.verse);
                const newQueryResult = { verses: state.checkedVerses, address: "" };
                history.updateContent(newQueryResult, true, { type: 'checked', term: 'ì„ íƒëœ êµ¬ì ˆ' });
            },

            clearSelection: function() {
                state.checkedVerses = [];
                dom['search-result-display'].querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                ui.toggleSelectionControls();
            },

            removeHighlight: function() {
                dom['highlight-input'].value = '';
                dom['highlight-bold'].checked = false;
                dom['highlight-italic'].checked = false;
                dom['highlight-underline'].checked = false;
                ui.renderContent();
            },

            syncScroll: function(e) {
                if (!state.displayWindow || state.displayWindow.closed) return;
                const preview = e.target;
                const secondary = state.displayWindow.document.documentElement;
                if (Math.abs(preview.scrollTop - secondary.scrollTop) < 5) return;
                const scrollPercentage = preview.scrollTop / (preview.scrollHeight - preview.clientHeight);
                secondary.scrollTop = scrollPercentage * (secondary.scrollHeight - secondary.clientHeight);
            },
            
            openReferenceWindow: function() {
                if (state.referenceWindow && !state.referenceWindow.closed) {
                    state.referenceWindow.focus();
                    return;
                }
                state.referenceWindow = window.open('', 'ReferenceWindow', 'width=500,height=600,scrollbars=yes');
                if (state.referenceWindow) {
                    const createSheetHtml = (sheetData) => {
                        if (Object.keys(sheetData).length === 0) return '<p class="text-slate-500 text-center p-4">ì°¸ê³  ë§ì”€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return Object.entries(sheetData).map(([category, verses]) => `
                            <div class="mb-4">
                                <h4 class="font-bold text-lg text-indigo-700">${category}</h4>
                                <div class="flex flex-wrap gap-2 mt-2">${verses.map(ref => `<button class="reference-verse-item bg-indigo-50 text-indigo-800 text-sm font-semibold px-3 py-1 rounded-full hover:bg-indigo-200" data-ref="${ref}">${ref}</button>`).join('')}</div>
                            </div>`).join('');
                    };
                    const content = `
                        <!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>ì°¸ê³  ë§ì”€</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <style>.toggle-content { display: none; } .toggle-header { cursor: pointer; }</style></head>
                        <body class="bg-slate-50 p-6">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">ì£¼ì œë³„ ì°¸ê³  ë§ì”€</h3>
                            <div id="reference-list-container" class="space-y-2">
                               <div class="border rounded-lg bg-white"><h4 class="toggle-header text-lg font-semibold p-3 bg-indigo-100 text-indigo-800 rounded-t-lg" data-toggle="evangelism">ì „ë„ìƒë‹´</h4><div class="toggle-content p-4 border-t" data-content="evangelism">${createSheetHtml(state.referenceVerses.evangelism || {})}</div></div>
                               <div class="border rounded-lg bg-white"><h4 class="toggle-header text-lg font-semibold p-3 bg-teal-100 text-teal-800 rounded-t-lg" data-toggle="life">ìƒí™œìƒë‹´</h4><div class="toggle-content p-4 border-t" data-content="life">${createSheetHtml(state.referenceVerses.life || {})}</div></div>
                            </div>
                            <script>
                                document.addEventListener('click', (e) => {
                                    if (e.target.classList.contains('toggle-header')) {
                                        const content = e.target.nextElementSibling;
                                        if (content) content.style.display = content.style.display === 'block' ? 'none' : 'block';
                                    } else if (e.target.classList.contains('reference-verse-item')) {
                                        if(window.opener && window.opener.appInterface) window.opener.appInterface.displayReferenceVerse(e.target.dataset.ref);
                                    }
                                });
                            <\/script></body></html>`;
                    state.referenceWindow.document.write(content);
                    state.referenceWindow.document.close();
                }
            },
            
            openReferenceManagerWindow: function() {
                if (state.referenceManagerWindow && !state.referenceManagerWindow.closed) {
                    state.referenceManagerWindow.focus(); return;
                }
                state.referenceManagerWindow = window.open('', 'ReferenceManagerWindow', 'width=600,height=700,scrollbars=yes');
                if (state.referenceManagerWindow) {
                    const createManagerCategoryHtml = (category, versesText) => {
                        const escapedCategory = category.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        const textareaContent = versesText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        return `
                        <div class="reference-category-manager p-3 bg-white rounded-lg shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <input type="text" value="${escapedCategory}" class="category-name-input font-bold text-lg text-rose-700 border-b-2 border-rose-200 focus:border-rose-500 bg-transparent outline-none flex-grow">
                                <button class="remove-category-btn text-red-500 hover:text-red-700 font-bold ml-2">X</button>
                            </div>
                            <textarea class="w-full h-24 p-2 border border-slate-300 rounded-md text-sm">${textareaContent}</textarea>
                        </div>`;
                    };
                    const createManagerSheetHtml = (sheetData) => Object.entries(sheetData).map(([category, verses]) => createManagerCategoryHtml(category, verses.join('\n'))).join('');
                    const managerEvangelismHtml = createManagerSheetHtml(state.referenceVerses.evangelism || {});
                    const managerLifeHtml = createManagerSheetHtml(state.referenceVerses.life || {});

                    const content = `
                        <!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>ì°¸ê³  ë§ì”€ ê´€ë¦¬</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <style>
                            .toggle-content { display: none; } .toggle-header { cursor: pointer; }
                            .toggle-container.active .toggle-content { display: block; } .toggle-container.active .toggle-header { background-color: #fbcfe8; }
                            ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f5f9; }
                            ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
                        </style>
                        </head>
                        <body class="bg-slate-50 p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-slate-800">ì°¸ê³  ë§ì”€ ê´€ë¦¬</h3>
                                <button id="add-category-btn" class="bg-green-500 text-white font-bold py-1 px-3 rounded-md hover:bg-green-600 text-sm" aria-label="ì¹´í…Œê³ ë¦¬ ì¶”ê°€">+</button>
                            </div>
                            <div id="manager-container" class="space-y-2" style="max-height: calc(100vh - 180px); overflow-y: auto;">
                                <div class="toggle-container active border rounded-lg bg-white" data-sheet="evangelism">
                                    <h4 class="toggle-header text-lg font-semibold p-3 bg-rose-100 text-rose-800 rounded-t-lg">ì „ë„ìƒë‹´</h4>
                                    <div class="toggle-content p-4 border-t space-y-4">${managerEvangelismHtml}</div>
                                </div>
                                <div class="toggle-container border rounded-lg bg-white" data-sheet="life">
                                    <h4 class="toggle-header text-lg font-semibold p-3 bg-cyan-100 text-cyan-800 rounded-t-lg">ìƒí™œìƒë‹´</h4>
                                    <div class="toggle-content p-4 border-t space-y-4">${managerLifeHtml}</div>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2 mt-4">
                                <button id="save-reference-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">ì €ì¥</button>
                                <button id="close-btn" class="bg-slate-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-600">ë‹«ê¸°</button>
                            </div>
                            <script>
                                document.addEventListener('DOMContentLoaded', () => {
                                    const app = window.opener.appInterface;
                                    const managerContainer = document.getElementById('manager-container');
                                    const createManagerCategoryElement = (category, versesText) => {
                                        const newDiv = document.createElement('div');
                                        newDiv.className = 'reference-category-manager p-3 bg-white rounded-lg shadow-sm';
                                        // Changed to string concatenation to avoid template literal conflict
                                        newDiv.innerHTML = '<div class="flex justify-between items-center mb-2"><input type="text" value="' + category + '" class="category-name-input font-bold text-lg text-rose-700 border-b-2 border-rose-200 focus:border-rose-500 bg-transparent outline-none flex-grow"><button class="remove-category-btn text-red-500 hover:text-red-700 font-bold ml-2">X</button></div><textarea class="w-full h-24 p-2 border border-slate-300 rounded-md text-sm">' + versesText + '</textarea>';
                                        return newDiv;
                                    };
                                    managerContainer.addEventListener('click', e => {
                                        if (e.target.classList.contains('toggle-header')) {
                                            const parentContainer = e.target.closest('.toggle-container');
                                            if (!parentContainer.classList.contains('active')) {
                                               document.querySelectorAll('.toggle-container').forEach(c => c.classList.remove('active'));
                                               parentContainer.classList.add('active');
                                            }
                                        } else if (e.target.classList.contains('remove-category-btn')) {
                                            app.showConfirmation("ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", confirmed => {
                                                if (confirmed) e.target.closest('.reference-category-manager').remove();
                                            });
                                        }
                                    });
                                    document.getElementById('add-category-btn').addEventListener('click', () => {
                                        const activeContainer = managerContainer.querySelector('.toggle-container.active .toggle-content');
                                        if (activeContainer) {
                                            const newCatElement = createManagerCategoryElement('ìƒˆ ì£¼ì œ', 'ì°½ 1:1\\nìš” 3:16');
                                            activeContainer.appendChild(newCatElement);
                                            newCatElement.querySelector('input').focus();
                                        } else {
                                            app.showNotification("ë¨¼ì € í™•ì¥í•  ìƒë‹´ ì£¼ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” (í´ë¦­í•˜ì—¬ í™œì„±í™”).");
                                        }
                                    });
                                    document.getElementById('save-reference-btn').addEventListener('click', () => {
                                        app.showConfirmation('ë³€ê²½ ì‚¬í•­ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', confirmed => {
                                            if (!confirmed) return;
                                            const newReferenceVerses = { evangelism: {}, life: {} };
                                            let hasError = false;
                                            document.querySelectorAll('.toggle-container').forEach(container => {
                                                if (hasError) return;
                                                const sheet = container.dataset.sheet;
                                                if (!sheet) return;
                                                container.querySelectorAll('.reference-category-manager').forEach(div => {
                                                    if (hasError) return;
                                                    const categoryNameInput = div.querySelector('.category-name-input');
                                                    const categoryName = categoryNameInput.value.trim();
                                                    const versesText = div.querySelector('textarea').value.trim();
                                                    if (categoryName) {
                                                        if (newReferenceVerses[sheet][categoryName]) {
                                                            // Changed to string concatenation to avoid template literal conflict
                                                            app.showNotification('ì˜¤ë¥˜: \\'' + sheet + '\\' ì‹œíŠ¸ì—ì„œ \\'' + categoryName + '\\' ì¹´í…Œê³ ë¦¬ ì´ë¦„ì´ ì¤‘ë³µë©ë‹ˆë‹¤.');
                                                            hasError = true; categoryNameInput.focus(); return;
                                                        }
                                                        const verses = versesText.split(/\\r?\\n|\\n/).map(v => v.trim()).filter(Boolean);
                                                        const invalidVerses = verses.filter(v => !app.parseVerseReference(v));
                                                        if (invalidVerses.length > 0) {
                                                            // Changed to string concatenation to avoid template literal conflict
                                                            app.showNotification('ì˜¤ë¥˜: \\'' + categoryName + '\\' ì¹´í…Œê³ ë¦¬ì— ì˜ëª»ëœ í˜•ì‹ì˜ êµ¬ì ˆì´ ìˆìŠµë‹ˆë‹¤:\\n\\n- ' + invalidVerses.join('\\n- '));
                                                            hasError = true; div.querySelector('textarea').focus(); return;
                                                        }
                                                        newReferenceVerses[sheet][categoryName] = verses;
                                                    }
                                                });
                                            });
                                            if (!hasError) app.saveReferenceVerses(newReferenceVerses);
                                        });
                                    });
                                    document.getElementById('close-btn').addEventListener('click', () => window.close());
                                });
                            <\/script>
                        </body></html>`;
                    state.referenceManagerWindow.document.write(content);
                    state.referenceManagerWindow.document.close();
                }
            },

            openAddToReferenceModal: function(historyIndex) {
                dom['add-to-reference-modal'].dataset.historyIndex = historyIndex;
                handlers.populateCategorySelect();
                dom['new-reference-category-input'].value = '';
                dom['add-to-reference-modal'].classList.remove('hidden');
                dom['add-to-reference-modal'].classList.add('flex');
            },

            populateCategorySelect: function() {
                const sheet = dom['reference-sheet-select'].value;
                const categories = state.referenceVerses[sheet] || {};
                dom['reference-category-select'].innerHTML = '<option value="">-- ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ ì„ íƒ --</option>';
                Object.keys(categories).forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    dom['reference-category-select'].appendChild(option);
                });
            },
            
            saveToReference: function() {
                const index = parseInt(dom['add-to-reference-modal'].dataset.historyIndex, 10);
                const historyItem = state.searchHistory[index];
                if (!historyItem) return;

                const sheet = dom['reference-sheet-select'].value;
                const newCategory = dom['new-reference-category-input'].value.trim();
                const selectedCategory = dom['reference-category-select'].value;
                let targetCategory = newCategory || selectedCategory;

                if (!targetCategory) return ui.showNotification('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                let versesToAdd = [];
                if (historyItem.type === 'verse') {
                    versesToAdd.push(historyItem.term);
                } else if (historyItem.type === 'checked' && historyItem.result?.verses) {
                    historyItem.result.verses.forEach(v => {
                        const bookName = state.bookInfoMap[v.book].abbr;
                        versesToAdd.push(`${bookName} ${v.chapter}:${v.verse}`);
                    });
                }

                if (versesToAdd.length === 0) return ui.showNotification('ì°¸ê³  ë§ì”€ì— ì¶”ê°€í•  êµ¬ì ˆì´ ì—†ìŠµë‹ˆë‹¤.');

                if (!state.referenceVerses[sheet]) state.referenceVerses[sheet] = {};
                if (!state.referenceVerses[sheet][targetCategory]) state.referenceVerses[sheet][targetCategory] = [];

                versesToAdd.forEach(verse => {
                    if (!state.referenceVerses[sheet][targetCategory].includes(verse)) {
                        state.referenceVerses[sheet][targetCategory].push(verse);
                    }
                });

                core.saveReferenceData(state.referenceVerses);
                ui.showNotification(`'${targetCategory}' ì¹´í…Œê³ ë¦¬ì— ë§ì”€ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                dom['add-to-reference-modal'].classList.add('hidden');
            },
        };

        /**
         * Sets up all event listeners for the application.
         */
        function bindEventListeners() {
            dom['db-file-input'].addEventListener('change', (e) => core.initializeDatabase(e.target.files[0]));
            dom['logo-file-input'].addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        state.logoSrc = ev.target.result;
                        dom['logo-status'].textContent = `ì„ íƒëœ ë¡œê³ : ${file.name}`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            dom['password-submit-btn'].addEventListener('click', handlers.checkPassword);
            dom['password-input'].addEventListener('keyup', (e) => { if (e.key === 'Enter') handlers.checkPassword(); });
            dom['change-password-btn'].addEventListener('click', handlers.changePassword);
            
            dom['open-window-btn'].addEventListener('click', ui.openDisplayWindow);
            dom['reopen-window-btn'].addEventListener('click', ui.openDisplayWindow);
            dom['display-btn'].addEventListener('click', handlers.displayVerse);
            dom['verse-input'].addEventListener('keyup', (e) => { if (e.key === 'Enter') handlers.displayVerse(); });
            
            dom['prev-verse-btn'].addEventListener('click', history.goBack);
            dom['next-verse-btn'].addEventListener('click', history.goForward);
            
            dom['keyword-search-btn'].addEventListener('click', handlers.performKeywordSearch);
            dom['keyword-input'].addEventListener('keyup', (e) => { if (e.key === 'Enter') handlers.performKeywordSearch(); });
            
            dom['display-custom-text-btn'].addEventListener('click', handlers.displayCustomText);
            dom['display-checked-btn'].addEventListener('click', handlers.displayCheckedVerses);
            
            dom['apply-highlight-btn'].addEventListener('click', ui.renderContent);
            dom['highlight-input'].addEventListener('keyup', (e) => { if (e.key === 'Enter') ui.renderContent(); });
            dom['remove-highlight-btn'].addEventListener('click', handlers.removeHighlight);

            [dom['font-size-slider'], dom['line-height-slider'], dom['custom-text-font-size-slider'], dom['custom-text-color']].forEach(el => {
                el.addEventListener('input', ui.updateAllStyles);
            });
            
            dom['custom-text-align-group'].addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button) {
                    state.customTextAlign = button.dataset.align;
                    e.currentTarget.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    ui.updateAllStyles();
                }
            });
            dom['custom-text-valign-group'].addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (button) {
                    state.customVerticalAlign = button.dataset.valign;
                    e.currentTarget.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    ui.updateAllStyles();
                }
            });

            dom['preview-display'].addEventListener('scroll', handlers.syncScroll);
            
            // Event delegation for search results
            dom['search-result-display'].addEventListener('click', (e) => {
                const content = e.target.closest('.verse-content');
                const checkbox = e.target.closest('.verse-checkbox');
                
                if (content) {
                    handlers.clearSelection();
                    const verseData = JSON.parse(content.previousElementSibling.dataset.verse);
                    const newQueryResult = { verses: [verseData], address: content.dataset.address };
                    history.updateContent(newQueryResult, false, { type: 'verse', term: content.dataset.address });
                } else if (checkbox) {
                    const data = JSON.parse(checkbox.dataset.verse);
                    if (checkbox.checked) {
                        state.checkedVerses.push(data);
                    } else {
                        state.checkedVerses = state.checkedVerses.filter(v => !(v.book === data.book && v.chapter === data.chapter && v.verse === data.verse));
                    }
                    ui.toggleSelectionControls();
                }
            });

            // Event delegation for history list
            dom['history-list'].addEventListener('click', (e) => {
                const item = e.target.closest('.history-item');
                if (!item) return;

                const historyIndex = parseInt(item.dataset.historyIndex, 10);
                const historyItem = state.searchHistory[historyIndex];

                if (e.target.closest('.history-content-btn')) {
                    if (historyItem.result) {
                        history.updateContent(historyItem.result, historyItem.type === 'checked', null);
                    } else if (historyItem.type === 'keyword') {
                        dom['keyword-input'].value = historyItem.term;
                        handlers.performKeywordSearch();
                    }
                    closeModal(dom['history-modal']);
                } else if (e.target.closest('.add-to-ref-btn')) {
                    handlers.openAddToReferenceModal(historyIndex);
                }
            });
            
            // Modals
            const modals = document.querySelectorAll('.modal');
            const openModal = (modal) => { modal.classList.remove('hidden'); modal.classList.add('flex'); };
            const closeModal = (modal) => { modal.classList.add('hidden'); modal.classList.remove('flex'); };
            dom['open-style-modal-btn'].addEventListener('click', () => openModal(dom['style-modal']));
            dom['close-style-modal-btn'].addEventListener('click', () => closeModal(dom['style-modal']));
            dom['open-guide-modal-btn'].addEventListener('click', () => openModal(dom['guide-modal']));
            dom['close-guide-modal-btn'].addEventListener('click', () => closeModal(dom['guide-modal']));
            dom['open-history-modal-btn'].addEventListener('click', () => { ui.populateHistoryList(); openModal(dom['history-modal']); });
            dom['close-history-modal-btn'].addEventListener('click', () => closeModal(dom['history-modal']));
            dom['add-to-reference-cancel-btn'].addEventListener('click', () => closeModal(dom['add-to-reference-modal']));
            modals.forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); }));

            // Reference Verses
            dom['open-reference-btn'].addEventListener('click', handlers.openReferenceWindow);
            dom['open-reference-manager-btn'].addEventListener('click', handlers.openReferenceManagerWindow);
            dom['add-to-reference-save-btn'].addEventListener('click', handlers.saveToReference);
            dom['reference-sheet-select'].addEventListener('change', handlers.populateCategorySelect);
        }

        /**
         * Application initializer.
         */
        function init() {
            cacheDomElements();
            if (!localStorage.getItem('bibleProjectorPassword')) {
                localStorage.setItem('bibleProjectorPassword', config.defaultPassword);
            }
            core.loadReferenceVerses();
            bindEventListeners();
            ui.updateNavButtonStates();
        }

        // Expose functions needed by popup windows to the global scope under a single namespace
        window.appInterface = {
            navigate: (direction, isShift = false) => {
                if (!state.lastQueryResult || state.isMultiSelectMode || state.lastQueryResult.verses[0]?.type === 'custom') return;
                
                if (isShift) {
                    const verses = state.lastQueryResult.verses;
                    const startVerseInfo = verses[0];
                    const endVerseInfo = verses[verses.length - 1];
                    let newEndVerse = endVerseInfo.verse + (direction === 'next' ? 1 : -1);
                    if (newEndVerse < startVerseInfo.verse) newEndVerse = startVerseInfo.verse;
                    const newParsedRef = { bookId: startVerseInfo.book, chapter: startVerseInfo.chapter, startVerse: startVerseInfo.verse, endVerse: newEndVerse, bookName: state.bookInfoMap[startVerseInfo.book].name };
                    const newResult = core.queryBible(newParsedRef);
                    if (newResult?.verses.length > 0) {
                        dom['verse-input'].value = newResult.address;
                        history.updateContent(newResult, false, { type: 'verse', term: newResult.address });
                    }
                } else {
                    const currentVerseInfo = state.lastQueryResult.verses[0];
                    const newVerseNumber = currentVerseInfo.verse + (direction === 'next' ? 1 : -1);
                    if (newVerseNumber < 1) return;
                    const newParsedRef = { bookId: currentVerseInfo.book, chapter: currentVerseInfo.chapter, startVerse: newVerseNumber, endVerse: newVerseNumber, bookName: state.bookInfoMap[currentVerseInfo.book].name };
                    const newResult = core.queryBible(newParsedRef);
                    if (newResult?.verses.length > 0) {
                        dom['verse-input'].value = newResult.address;
                        history.updateContent(newResult, false, { type: 'verse', term: newResult.address });
                    }
                }
            },
            navigateVerseByKey: (e) => {
                const direction = e.key === 'ArrowRight' ? 'next' : 'prev';
                window.appInterface.navigate(direction, e.shiftKey);
            },
            navigateVerseByClick: (direction) => {
                window.appInterface.navigate(direction, false); // Click doesn't support shift-key range selection
            },
            displayReferenceVerse: (ref) => {
                const result = core.queryBible(core.parseVerseReference(ref));
                if (result?.verses.length > 0) {
                    history.updateContent(result, false, { type: 'verse', term: ref });
                } else {
                    ui.showNotification(`'${ref}' ë§ì”€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }
            },
            saveReferenceVerses: (data) => {
                core.saveReferenceData(data);
                if (state.referenceManagerWindow && !state.referenceManagerWindow.closed) state.referenceManagerWindow.close();
                ui.showNotification('ì°¸ê³  ë§ì”€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            },
            showNotification: ui.showNotification,
            showConfirmation: ui.showConfirmation,
            parseVerseReference: core.parseVerseReference,
        };

        // Start the application on DOM content loaded
        document.addEventListener('DOMContentLoaded', init);

    })();
    </script>
</body>
</html>
